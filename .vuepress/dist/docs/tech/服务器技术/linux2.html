<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Linux2</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.88b3a504.css" as="style"><link rel="preload" href="/assets/js/app.f8154061.js" as="script"><link rel="preload" href="/assets/js/2.4cccd600.js" as="script"><link rel="preload" href="/assets/js/42.3f849176.js" as="script"><link rel="prefetch" href="/assets/js/10.54f00d7a.js"><link rel="prefetch" href="/assets/js/11.3da5b74a.js"><link rel="prefetch" href="/assets/js/12.7fee73d6.js"><link rel="prefetch" href="/assets/js/13.76868392.js"><link rel="prefetch" href="/assets/js/14.73742d11.js"><link rel="prefetch" href="/assets/js/15.5f9a7bea.js"><link rel="prefetch" href="/assets/js/16.bc63dc43.js"><link rel="prefetch" href="/assets/js/17.cf9ef8d3.js"><link rel="prefetch" href="/assets/js/18.813f3d8e.js"><link rel="prefetch" href="/assets/js/19.381f5e21.js"><link rel="prefetch" href="/assets/js/20.e6f846bb.js"><link rel="prefetch" href="/assets/js/21.699eb7d8.js"><link rel="prefetch" href="/assets/js/22.9b419f3a.js"><link rel="prefetch" href="/assets/js/23.9e2fcc0f.js"><link rel="prefetch" href="/assets/js/24.c0934c78.js"><link rel="prefetch" href="/assets/js/25.4d32001d.js"><link rel="prefetch" href="/assets/js/26.6a089853.js"><link rel="prefetch" href="/assets/js/27.b32725bd.js"><link rel="prefetch" href="/assets/js/28.a7d1db61.js"><link rel="prefetch" href="/assets/js/29.ee4f84ac.js"><link rel="prefetch" href="/assets/js/3.6608d946.js"><link rel="prefetch" href="/assets/js/30.c1000c38.js"><link rel="prefetch" href="/assets/js/31.694fd1d6.js"><link rel="prefetch" href="/assets/js/32.ac026d3a.js"><link rel="prefetch" href="/assets/js/33.c8ee999f.js"><link rel="prefetch" href="/assets/js/34.6663a77a.js"><link rel="prefetch" href="/assets/js/35.da0b5d07.js"><link rel="prefetch" href="/assets/js/36.75f20762.js"><link rel="prefetch" href="/assets/js/37.df31ffd6.js"><link rel="prefetch" href="/assets/js/38.848c2684.js"><link rel="prefetch" href="/assets/js/39.9a7a0d1a.js"><link rel="prefetch" href="/assets/js/4.9660033f.js"><link rel="prefetch" href="/assets/js/40.ca8e34ae.js"><link rel="prefetch" href="/assets/js/41.ab3f4971.js"><link rel="prefetch" href="/assets/js/43.9b90ce3e.js"><link rel="prefetch" href="/assets/js/44.196181d0.js"><link rel="prefetch" href="/assets/js/45.4ebcccbd.js"><link rel="prefetch" href="/assets/js/46.a68cdba9.js"><link rel="prefetch" href="/assets/js/47.d26979d7.js"><link rel="prefetch" href="/assets/js/48.f6c3543c.js"><link rel="prefetch" href="/assets/js/49.87b9dc0d.js"><link rel="prefetch" href="/assets/js/5.bbf68f26.js"><link rel="prefetch" href="/assets/js/50.0d956d0a.js"><link rel="prefetch" href="/assets/js/51.6d654f81.js"><link rel="prefetch" href="/assets/js/52.180028c6.js"><link rel="prefetch" href="/assets/js/53.688b8ed0.js"><link rel="prefetch" href="/assets/js/54.4760398b.js"><link rel="prefetch" href="/assets/js/55.79d61c82.js"><link rel="prefetch" href="/assets/js/56.22ba5d85.js"><link rel="prefetch" href="/assets/js/57.085d3e52.js"><link rel="prefetch" href="/assets/js/58.a778b7b9.js"><link rel="prefetch" href="/assets/js/59.2ea1a17d.js"><link rel="prefetch" href="/assets/js/6.690811ac.js"><link rel="prefetch" href="/assets/js/60.82c5f4a5.js"><link rel="prefetch" href="/assets/js/61.9851b4bf.js"><link rel="prefetch" href="/assets/js/62.e9ca8158.js"><link rel="prefetch" href="/assets/js/63.44d8baf4.js"><link rel="prefetch" href="/assets/js/64.df339ab2.js"><link rel="prefetch" href="/assets/js/65.ac505688.js"><link rel="prefetch" href="/assets/js/66.3af3b829.js"><link rel="prefetch" href="/assets/js/67.41c1aab0.js"><link rel="prefetch" href="/assets/js/68.5d9e177d.js"><link rel="prefetch" href="/assets/js/69.d3e85f6e.js"><link rel="prefetch" href="/assets/js/7.491a7910.js"><link rel="prefetch" href="/assets/js/70.4494003e.js"><link rel="prefetch" href="/assets/js/71.6e2116c7.js"><link rel="prefetch" href="/assets/js/72.49cda61b.js"><link rel="prefetch" href="/assets/js/73.e7e66ead.js"><link rel="prefetch" href="/assets/js/74.5e98329f.js"><link rel="prefetch" href="/assets/js/75.3dd401e4.js"><link rel="prefetch" href="/assets/js/76.aabec56b.js"><link rel="prefetch" href="/assets/js/77.95564de2.js"><link rel="prefetch" href="/assets/js/78.69634719.js"><link rel="prefetch" href="/assets/js/79.6fcc3d23.js"><link rel="prefetch" href="/assets/js/8.63bf7718.js"><link rel="prefetch" href="/assets/js/9.58039158.js">
    <link rel="stylesheet" href="/assets/css/0.styles.88b3a504.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="linux2"><a href="#linux2" class="header-anchor">#</a> Linux2</h2> <p>​		服务器配置</p> <p></p> <h2 id="nginx"><a href="#nginx" class="header-anchor">#</a> Nginx</h2> <p>Nginx是常用的网络服务器，ubuntu和debian类似，这里以centos7为例</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>yum install nginx
</code></pre></div><p>nginx的默认安装目录为<code>/usr/local/nginx</code>,配置文件的目录为<code>/usr/local/nginx/conf/nginx.conf</code></p> <p>启动nginx服务</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>systemctl enable nginx<span class="token punctuation">.</span>service 
systemctl start nginx<span class="token punctuation">.</span>service
systemctl stop nginx<span class="token punctuation">.</span>service
systemctl restart nginx<span class="token punctuation">.</span>service
</code></pre></div><p>nginx命令</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>nginx <span class="token operator">-</span>s reload  <span class="token comment"># 热重启</span>
nginx <span class="token operator">-</span>s reopen  <span class="token comment"># 重启Nginx</span>
nginx <span class="token operator">-</span>s stop    <span class="token comment"># 快速关闭</span>
nginx <span class="token operator">-</span>s quit    <span class="token comment"># 等待工作进程处理完成后关闭</span>
nginx <span class="token operator">-</span>T         <span class="token comment"># 查看配置文件的实际内容</span>
</code></pre></div><h3 id="默认主页、目录访问"><a href="#默认主页、目录访问" class="header-anchor">#</a> 默认主页、目录访问</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">root</span> <span class="token operator">/</span>网站根目录<span class="token punctuation">;</span>
  <span class="token comment"># 优先使用默认主页</span>
  <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm <span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token punctuation">;</span>
  <span class="token comment"># 当默认主页不存在时直接列出目录内文件树</span>
  <span class="token keyword">autoindex</span> on<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="反向代理"><a href="#反向代理" class="header-anchor">#</a> 反向代理</h3> <p>先了解正向代理</p> <p>正向代理：局域网中的电脑用户想要直接访问网络是不可行的，只能通过代理服务器来访问，这种代理服务就被称为正向代理。</p> <p>反向代理是一个<code>Web</code>服务器，它接受客户端的连接请求，然后将请求转发给上游服务器，并将从服务器得到的结果返回给连接的客户端。</p> <p>客户端访问网络不需要配置，只要把请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据，然后再返回到客户端，此时反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器IP地址</p> <p>location匹配规则：</p> <p>～：正则匹配，区分大小写</p> <p>～*：正则匹配，不区分大小写</p> <p>@：定义一个命名的location，用于内部定向，例如error_page、try_files</p> <p>=：普通字符匹配，精确匹配</p> <p>^～：普通字符匹配，如果该选项匹配，则只匹配该选项，不再向下匹配其他选项</p> <p>匹配优先级（与location书写的先后顺序关系不大）：</p> <p>1.精确匹配：=符号严格匹配这个查询，如果找到，停止搜索，</p> <p>2.普通字符匹配：所有剩下的常规字符串，最长的匹配；如果找到^~这个符号停止搜索；</p> <p>3.正则匹配；</p> <p>4.默认匹配：如果第三条条件生效使用第三条，否则使用第二条</p> <p>nginx做http反向代理</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>api <span class="token punctuation">{</span>
  <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.40</span><span class="token number">.174</span><span class="token punctuation">:</span><span class="token number">32020</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">server</span><span class="token punctuation">{</span>
  <span class="token keyword">listen</span><span class="token punctuation">:</span><span class="token number">90</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span><span class="token punctuation">:</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span>
    
  <span class="token keyword">location</span> <span class="token operator">/</span>edu<span class="token operator">/</span><span class="token punctuation">{</span>
    <span class="token keyword">root</span> html<span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.40</span><span class="token number">.174</span><span class="token punctuation">:</span><span class="token number">32020</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">location</span> <span class="token operator">/</span>ovd<span class="token operator">/</span><span class="token punctuation">{</span>
    <span class="token keyword">root</span> html<span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.40</span><span class="token number">.174</span><span class="token punctuation">:</span><span class="token number">32020</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更多指令说明</p> <table><thead><tr><th style="text-align:left;">指令</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>proxy_connect_timeout</code></td> <td style="text-align:left;"><code>Nginx</code>从接受请求至连接到上游服务器的最长等待时间</td></tr> <tr><td style="text-align:left;"><code>proxy_send_timeout</code></td> <td style="text-align:left;">后端服务器数据回传时间(代理发送超时)</td></tr> <tr><td style="text-align:left;"><code>proxy_read_timeout</code></td> <td style="text-align:left;">连接成功后，后端服务器响应时间(代理接收超时)</td></tr> <tr><td style="text-align:left;"><code>proxy_cookie_domain</code></td> <td style="text-align:left;">替代从上游服务器来的<code>Set-Cookie</code>头的<code>domain</code>属性</td></tr> <tr><td style="text-align:left;"><code>proxy_cookie_path</code></td> <td style="text-align:left;">替代从上游服务器来的<code>Set-Cookie</code>头的<code>path</code>属性</td></tr> <tr><td style="text-align:left;"><code>proxy_buffer_size</code></td> <td style="text-align:left;">设置代理服务器（<code>nginx</code>）保存用户头信息的缓冲区大小</td></tr> <tr><td style="text-align:left;"><code>proxy_buffers</code></td> <td style="text-align:left;"><code>proxy_buffers</code>缓冲区，网页平均在多少<code>k</code>以下</td></tr> <tr><td style="text-align:left;"><code>proxy_set_header</code></td> <td style="text-align:left;">重写发送到上游服务器头的内容，也可以通过将某个头部的值设置为空字符串，而不发送某个头部的方法实现</td></tr> <tr><td style="text-align:left;"><code>proxy_ignore_headers</code></td> <td style="text-align:left;">这个指令禁止处理来自代理服务器的应答。</td></tr> <tr><td style="text-align:left;"><code>proxy_intercept_errors</code></td> <td style="text-align:left;">使<code>nginx</code>阻止<code>HTTP</code>应答代码为400或者更高的应答。</td></tr></tbody></table> <h4 id="泛域名转发"><a href="#泛域名转发" class="header-anchor">#</a> 泛域名转发</h4> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> <span class="token operator">~</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\w<span class="token operator">-</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">)</span>\<span class="token punctuation">.</span><span class="token keyword">user</span>\<span class="token punctuation">.</span>demo\<span class="token punctuation">.</span>com$<span class="token punctuation">;</span>
  
  <span class="token comment">#配合上面语句可以把不同的域名转发到不同目录，如xuexb.user.demo.com-&gt; /home/user/wwwroot/user/xuexb a01.user.demo.com-&gt; /home/user/wwwroot/user/a01</span>
  <span class="token keyword">root</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>wwwroot<span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>$<span class="token number">1</span><span class="token punctuation">;</span>
  
  <span class="token comment">## xuexb.user.demo.com/path -&gt; 127.0.0.1:8080/xuexb/path a01.user.demo.com/path -&gt; 127.0.0.1:8080/a01/path</span>
  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>NginX<span class="token operator">-</span><span class="token keyword">Proxy</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span>$<span class="token number">1</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="nodejs"><a href="#nodejs" class="header-anchor">#</a> Nodejs</h4> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">server_name</span> www<span class="token punctuation">.</span>xxoo<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  
  <span class="token keyword">root</span> <span class="token operator">/</span>wwwroot<span class="token operator">/</span>www<span class="token punctuation">.</span>xxoo<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span>f <span class="token variable">$request_filename</span><span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">rewrite</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> $<span class="token number">1</span><span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>f <span class="token variable">$request_filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">rewrite</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>js<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>js <span class="token punctuation">{</span>
    
    <span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>NginX<span class="token operator">-</span><span class="token keyword">Proxy</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8001</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    
    <span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="配置浏览器缓存"><a href="#配置浏览器缓存" class="header-anchor">#</a> 配置浏览器缓存</h3> <p>不缓存</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">expires</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if_modified_since</span> off<span class="token punctuation">;</span><span class="token comment">##</span>
<span class="token punctuation">}</span>
<span class="token comment">## Cache-Control: no-cache;</span>
</code></pre></div><p>设置缓存</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">expires</span> <span class="token number">1</span>d<span class="token punctuation">;</span>
  <span class="token comment">## expires max;</span>
<span class="token punctuation">}</span>
<span class="token comment">## Cache-Control: max-age=315360000</span>
</code></pre></div><p>根据路径设置不同的缓存策略</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">set</span> <span class="token variable">$expires_time</span> <span class="token number">1</span>M<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$request_uri</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token function">admin</span><span class="token punctuation">(</span>\<span class="token operator">/</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">?</span>$<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$expires_time</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$request_uri</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token function">admin</span><span class="token punctuation">(</span>\<span class="token operator">/</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">?</span>$<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$expires_time</span> max<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">expires</span> <span class="token variable">$expires_time</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h3> <p><code>upstream</code>模块能够使用3种负载均衡算法：轮询、<code>IP</code>哈希、最少连接数。</p> <p><strong>轮询：</strong> 默认情况下使用轮询算法，不需要配置指令来激活它，它是基于在队列中谁是下一个的原理确保访问均匀地分布到每个上游服务器；</p> <p>轮询时考研指定轮询几率，<code>weight</code>和访问比率成正比，用于后端服务器性能不均的情况。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment">#10次一般只会有1次会访问到8081，而有9次会访问到8080</span>
<span class="token keyword">upstream</span> test <span class="token punctuation">{</span>
    <span class="token keyword">server</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span> weight<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> localhost<span class="token punctuation">:</span><span class="token number">8081</span> weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>IP哈希：</strong> 通过<code>ip_hash</code>指令来激活，<code>Nginx</code>通过<code>IPv4</code>地址的前<code>3</code>个字节或者整个<code>IPv6</code>地址作为哈希键来实现，同一个IP地址总是能被映射到同一个上游服务器；</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> test <span class="token punctuation">{</span>
    <span class="token keyword">ip_hash</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> localhost<span class="token punctuation">:</span><span class="token number">8081</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>最少连接数：</strong> 通过<code>least_conn</code>指令来激活，该算法通过选择一个活跃数最少的上游服务器进行连接。如果上游服务器处理能力不同，可以通过给<code>server</code>配置<code>weight</code>权重来说明，该算法将考虑到不同服务器的加权最少连接数。</p> <p>upstream使用第三方模块</p> <p>Fair：按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backend <span class="token punctuation">{</span>
    fair<span class="token punctuation">;</span>
    <span class="token keyword">server</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> localhost<span class="token punctuation">:</span><span class="token number">8081</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>url_hash:这是个第三方模块，按访问<code>url</code>的<code>hash</code>结果来分配请求，使每个<code>url</code>定向到同一个后端服务器，后端服务器为缓存时比较有效。 在<code>upstream</code>中加入<code>hash</code>语句，<code>server</code>语句中不能写入<code>weight</code>等其他的参数，<code>hash_method</code>是使用的<code>hash</code>算法</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backend <span class="token punctuation">{</span>
    hash <span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    hash_method crc32<span class="token punctuation">;</span>
    <span class="token keyword">server</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> localhost<span class="token punctuation">:</span><span class="token number">8081</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="支持cors跨域"><a href="#支持cors跨域" class="header-anchor">#</a> 支持CORS跨域</h3> <p>nginx配置做跨域处理--添加请求头</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>p<span class="token operator">/</span>asm <span class="token punctuation">{</span>
  <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.40</span><span class="token number">.174</span><span class="token punctuation">:</span><span class="token number">32020</span><span class="token punctuation">;</span>
  <span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token string">'*'</span> always<span class="token punctuation">;</span>
  <span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Credentials'</span> <span class="token string">'true'</span> always<span class="token punctuation">;</span>
  <span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token string">'GET,POST,PUT,DELETE,PATCH,OPTIONS'</span><span class="token punctuation">;</span>
  <span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Headers'</span> <span class="token string">'Content-Type,ssid'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token number">204</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
  <span class="token keyword">proxy_redirect</span>     off<span class="token punctuation">;</span>
  <span class="token keyword">proxy_set_header</span>   Host <span class="token variable">$host</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="高可用keep-alived"><a href="#高可用keep-alived" class="header-anchor">#</a> 高可用keep-alived</h3> <p>正常情况下nginx是可以访问的，但是如果nginx出现宕机或者内存不够等程序错误，就会堵塞请求。为了防止这种情况的发生，配置高可用keep-alived进行预防</p> <p>安装keep-alived</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> keepalived -y
<span class="token function">rpm</span> -q -a keepalived
//keepalived-1.3.5-16.el7.x86_64
</code></pre></div><p>修改配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl start keepalived.service
<span class="token function">vi</span> keepalived.conf 
</code></pre></div><p>把原主机ip地址换为虚拟ip</p> <div class="language-shell extra-class"><pre class="language-shell"><code>global_defs <span class="token punctuation">{</span>
   notification_email <span class="token punctuation">{</span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   <span class="token punctuation">}</span>
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server <span class="token number">192.168</span>.25.147
   smtp_connect_timeout <span class="token number">30</span>
   router_id LVS_DEVEL <span class="token comment"># 访问的主机地址</span>
<span class="token punctuation">}</span>
vrrp_script chk_nginx <span class="token punctuation">{</span>
  script <span class="token string">&quot;/usr/local/src/nginx_check.sh&quot;</span>  <span class="token comment"># 检测文件的地址</span>
  interval <span class="token number">2</span>   <span class="token comment"># 检测脚本执行的间隔</span>
  weight <span class="token number">2</span>   <span class="token comment"># 权重</span>
<span class="token punctuation">}</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
    state BACKUP    <span class="token comment"># 主机MASTER、备机BACKUP    </span>
    interface ens33   <span class="token comment"># 网卡</span>
    virtual_router_id <span class="token number">51</span> <span class="token comment"># 同一组需一致</span>
    priority <span class="token number">90</span>  <span class="token comment"># 访问优先级，主机值较大，备机较小</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass <span class="token number">1111</span>
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">192.168</span>.25.50  <span class="token comment"># 虚拟ip</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>启动keep-alived</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl start keepalived.service
</code></pre></div><h3 id="屏蔽ip-国外ip"><a href="#屏蔽ip-国外ip" class="header-anchor">#</a> 屏蔽ip/国外ip</h3> <p>在<code>nginx</code>的配置文件<code>nginx.conf</code>中加入如下配置，可以放到<code>http</code>, <code>server</code>, <code>location</code>, <code>limit_except</code>语句块，需要注意相对路径，本例当中<code>nginx.conf</code>，<code>blocksip.conf</code>在同一个目录中</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">include</span> blockip<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
</code></pre></div><p>blockip.conf</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">deny</span> IP<span class="token punctuation">;</span>   <span class="token comment"># 屏蔽单个ip访问</span>
<span class="token keyword">allow</span> IP<span class="token punctuation">;</span>  <span class="token comment"># 允许单个ip访问</span>
<span class="token keyword">deny</span> all<span class="token punctuation">;</span>  <span class="token comment"># 屏蔽所有ip访问</span>
<span class="token keyword">allow</span> all<span class="token punctuation">;</span> <span class="token comment"># 允许所有ip访问</span>
<span class="token keyword">deny</span> <span class="token number">123.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">8</span>   <span class="token comment"># 屏蔽整个段即从123.0.0.1到123.255.255.254访问的命令</span>
<span class="token keyword">deny</span> <span class="token number">124.45</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">16</span> <span class="token comment"># 屏蔽IP段即从123.45.0.1到123.45.255.254访问的命令</span>
<span class="token keyword">deny</span> <span class="token number">123.45</span><span class="token number">.6</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token comment"># 屏蔽IP段即从123.45.6.1到123.45.6.254访问的命令</span>
</code></pre></div><p>国外ip</p> <p>基于 Nginx 的 ngx_http_geoip2 模块来禁止国外 IP 访问网站。</p> <p>安装模块依赖</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> libmaxminddb-devel -y
</code></pre></div><p>下载模块</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/leev/ngx_http_geoip2_module.git
</code></pre></div><p>解压到/usr/local目录</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mv</span> ngx_http_geoip2_module/ /usr/local/
</code></pre></div><p>模块安装成功后，还要在 Nginx 里指定数据库，在安装运行库时默认安装了两个，位于 /usr/share/GeoIP/ 目录下，一个只有 IPv4，一个包含 IPv4 和 IPv6。</p> <p>登录 www.maxmind.com 网址，创建账户，下载最新的库文件。（账户创建就不演示了）点击左侧，Download Files：</p> <p>选择 GeoLite2 Country，点击 Download GZIP 下载即可：</p> <p>上传到 /usr/share/GeoIP/ 下并解压：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /usr/share/GeoIP/
</code></pre></div><p>在nginx.conf中的http中引入数据库文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code>geoip2 /usr/share/GeoIP/GeoLite2-City.mmdb <span class="token punctuation">{</span>
        auto_reload 5m<span class="token punctuation">;</span>
        <span class="token variable">$geoip2_data_country_code</span> country iso_code<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        map <span class="token variable">$geoip2_data_country_code</span> <span class="token variable">$allowed_country</span> <span class="token punctuation">{</span>
default <span class="token function">yes</span><span class="token punctuation">;</span>
        CN no<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>在 server 中的 location 下添加条件，如果满足 IP 是国外 IP，就执行下面的 return 动作，</p> <p>可以直接返回 404或者别的页面：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$allowed_country</span> <span class="token operator">=</span> yes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment"># return https://www.baidu.com;</span>
    <span class="token comment"># return /home/japan;</span>
    <span class="token keyword">return</span> <span class="token number">404</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="重定向"><a href="#重定向" class="header-anchor">#</a> 重定向</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token operator">/</span><span class="token operator">/</span>重定向网站
<span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">server_name</span> old<span class="token operator">-</span>site<span class="token punctuation">.</span>com
    <span class="token keyword">return</span> <span class="token number">301</span> <span class="token variable">$scheme</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>new<span class="token operator">-</span>site<span class="token punctuation">.</span>com<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">/</span><span class="token operator">/</span>重定向单页面
<span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span>oldpage<span class="token punctuation">.</span>html <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>org<span class="token operator">/</span>newpage<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">/</span><span class="token operator">/</span>重定向子路径
<span class="token keyword">location</span> <span class="token operator">/</span>old<span class="token operator">-</span>site <span class="token punctuation">{</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span>old<span class="token operator">-</span>site<span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>org<span class="token operator">/</span>new<span class="token operator">-</span>site<span class="token operator">/</span>$<span class="token number">1</span> permanent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="配置图片防盗链"><a href="#配置图片防盗链" class="header-anchor">#</a> 配置图片防盗链</h3> <p>防盗链是指当图片不是自己网站打开时返回403或者指定图片，通过判断请求的来路判断是否是自己的站点来设置</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    <span class="token keyword">valid_referers</span> none blocked <span class="token operator">*</span><span class="token punctuation">.</span>xuexb<span class="token punctuation">.</span>com server_names
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="https配置"><a href="#https配置" class="header-anchor">#</a> Https配置</h3> <h4 id="let-s-encrypt"><a href="#let-s-encrypt" class="header-anchor">#</a> let's Encrypt</h4> <p>let's Encrypt作为一个公共且免费SSL的项目逐渐被广大用户传播和使用，由Mozilla、Cisco、Akamai、IdenTrust等组织发起，主要的目的也是为了推进网站由http向https过度。</p> <p>let's Encrypt免费SSL证书的出现，也会对传统提供付费SSL证书服务的商家有不少的打击。目前Let‘s Encrypt获得IndenTrust交叉签名，也就是可以应用且支持包括Firefox、Chrome在内的主流浏览器的兼容和支持。</p> <p>使用git安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/letsencrypt/letsencrypt
</code></pre></div><p>生成证书</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> letsencrypt
./lensencrypt-auto certonly --standalone --email quiniton@163.com -d www.zhaoheqiang.me -d zhaoheqiang.me
</code></pre></div><p>执行命令之后，会在/etc/letsencrypt/live/下找到各个域名的文件夹，每个文件夹里面会有四个密钥证书文件：</p> <p>cert.pem：Apache服务器端证书</p> <p>chain.pem：Apache根证书和中继证书</p> <p>fullchain.pem：Nginx所需要的ssl_certificate文件</p> <p>privkey.pem：安全证书KEY文件</p> <p>如果是Nginx，使用fullchain.pem和privacy.pem文件，在配置文件中加入语句</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">https</span><span class="token punctuation">;</span>
	<span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>live<span class="token operator">/</span>www<span class="token punctuation">.</span>zhaoheqiang<span class="token punctuation">.</span>me<span class="token operator">/</span>fullchain<span class="token punctuation">.</span>pem
	<span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>live<span class="token operator">/</span>www<span class="token punctuation">.</span>zhaoheqiang<span class="token punctuation">.</span>me<span class="token operator">/</span>privkey<span class="token punctuation">.</span>pem
<span class="token punctuation">}</span>
</code></pre></div><p>延长有效期</p> <p>let's Encrypt的证书一般有有效期，需要手动更新续期</p> <div class="language-shell extra-class"><pre class="language-shell"><code>./lensencrypt-auto certonly --renew-by-default --email quiniton@163.com -d www.zhaoheqiang.me -d zhaoheqiang.me
</code></pre></div><h4 id="certbot"><a href="#certbot" class="header-anchor">#</a> certbot</h4> <p>certbot是let's Encrypt官方推荐的获取证书的客户端。可以帮我们获取免费的let's Encrypt证书。certbot支持所有unix内核的操作系统。</p> <p>安装certbot</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> certbot
</code></pre></div><p>获取证书</p> <div class="language-shell extra-class"><pre class="language-shell"><code>certbot certonly --standalone -d example.com -d www.example.com
</code></pre></div><p>也可以用指定根目录的方式生成证书</p> <div class="language-shell extra-class"><pre class="language-shell"><code>certbot certonly --webroot -w /var/www/example -d example.com -d www.example.com
</code></pre></div><p>证书生成后就可以在/etc/letsencrypt/live目录下看到对应域名的证书</p> <p>let's Encrypt提供的证书一般都有90天有效期，在证书到期之前需要更新证书，certbot提供自动更新</p> <div class="language-shell extra-class"><pre class="language-shell"><code>certbot renew --dry-run
</code></pre></div><p>安装时如果报错</p> <div class="language-shell extra-class"><pre class="language-shell"><code>Problem binding to port <span class="token number">80</span>:Could not <span class="token builtin class-name">bind</span> to IPv4 or IPv6
</code></pre></div><p>因为nginx占用80端口，需要先停掉nginx进行操作，执行自动更新时也需要停掉nginx</p> <h4 id="openssl"><a href="#openssl" class="header-anchor">#</a> openssl</h4> <p>先生成一个key</p> <div class="language-shell extra-class"><pre class="language-shell"><code>openssl genrsa -des3 -out ssl.key <span class="token number">1024</span>
</code></pre></div><p>根据key生成证书请求文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code>openssl req -new -key ssl.key -out ssl.csr
</code></pre></div><p>最后根据这两个文件生成crt证书文件，如果需要pfx可以用第二个命令生成</p> <div class="language-shell extra-class"><pre class="language-shell"><code>openssl x509 -req -days <span class="token number">3650</span> -in ssl.csr -signkey ssl.key -out ssl.cer
openssl pkcs12 -export -inkey ssl.key -in ssl.crt -out ssl.pfx
</code></pre></div><p>在需要使用证书的server中配置</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">ssl</span> on<span class="token punctuation">;</span>
  <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
  <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token keyword">ssl_session_timeout</span> <span class="token number">5</span>m<span class="token punctuation">;</span>
  <span class="token keyword">ssl_protocols</span> SSLv2 SSLv3 TLSv1<span class="token punctuation">;</span>
  <span class="token keyword">ssl_ciphers</span> ALL<span class="token punctuation">:</span><span class="token operator">!</span>EXPORT56<span class="token punctuation">:</span>RC4<span class="token operator">+</span>RSA<span class="token operator">+</span>HIGH<span class="token punctuation">:</span><span class="token operator">+</span>MEDIUM<span class="token operator">+</span>LOW<span class="token punctuation">:</span><span class="token operator">+</span>SSLv2<span class="token punctuation">:</span><span class="token operator">+</span>EXP<span class="token punctuation">;</span>
  ssl_prefer_server_cipher on<span class="token punctuation">;</span>
  
  <span class="token keyword">listen</span> <span class="token number">443</span><span class="token punctuation">;</span>
  <span class="token keyword">ssl</span> on<span class="token punctuation">;</span>
  <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>webserver<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>vhost<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span><span class="token keyword">server</span><span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
  <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>webserver<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>vhost<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span><span class="token keyword">server</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重启nginx就可以，使用https进行访问</p> <h4 id="nginx配置-http重定向到https"><a href="#nginx配置-http重定向到https" class="header-anchor">#</a> nginx配置/http重定向到https</h4> <p>不可以把301和proxy_pass写在同一个server中，会产生重定向次数过多的问题</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">server_name</span> www<span class="token punctuation">.</span>kunzhang<span class="token punctuation">.</span>me kunzhnag<span class="token punctuation">.</span>me<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$host</span> <span class="token operator">=</span> www<span class="token punctuation">.</span>kunzhang<span class="token punctuation">.</span>me<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token operator">/</span><span class="token variable">$request_url</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> <span class="token keyword">http</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
    <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>live<span class="token operator">/</span>diamondfsd<span class="token punctuation">.</span>com<span class="token operator">/</span>fullchain<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>
    <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>live<span class="token operator">/</span>diamondfsd<span class="token punctuation">.</span>com<span class="token operator">/</span>privkey<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>

    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">3999</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> X_FORWARDED_PROTO <span class="token keyword">https</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="缓冲优化"><a href="#缓冲优化" class="header-anchor">#</a> 缓冲优化</h3> <p>Nginx代理之后会有相应的代理缓存区，缓存区默认只有几十K，某些版本的nginx默认设置中没有相关处理，导致部分文件代理是会出现加载不全的现象，其实不仅仅是JS文件。只是因为框架的JS文件略大，所以经常出现类似问题。</p> <p>在nginx.conf中添加</p> <div class="language-conf extra-class"><pre class="language-text"><code>http {
	proxy_buffer_size 128k;
	proxy_buffers   32 128k;
	proxy_busy_buffers_size 128k;
}
</code></pre></div><h3 id="gzip压缩"><a href="#gzip压缩" class="header-anchor">#</a> gzip压缩</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">http</span> <span class="token punctuation">{</span>
  <span class="token comment"># 开启gzip</span>
  <span class="token keyword">gzip</span> on<span class="token punctuation">;</span>

  <span class="token comment"># 启用gzip压缩的最小文件，小于设置值的文件将不会压缩</span>
  <span class="token keyword">gzip_min_length</span> <span class="token number">1</span>k<span class="token punctuation">;</span>

  <span class="token comment"># gzip 压缩级别，1-10，数字越大压缩的越好，也越占用CPU时间</span>
  <span class="token keyword">gzip_comp_level</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment"># 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。</span>
  <span class="token keyword">gzip_types</span> text<span class="token operator">/</span>plain application<span class="token operator">/</span>javascript application<span class="token operator">/</span>x<span class="token operator">-</span>javascript text<span class="token operator">/</span>css application<span class="token operator">/</span>xml text<span class="token operator">/</span>javascript application<span class="token operator">/</span>x<span class="token operator">-</span>httpd<span class="token operator">-</span>php image<span class="token operator">/</span>jpeg image<span class="token operator">/</span>gif image<span class="token operator">/</span>png<span class="token punctuation">;</span>

  <span class="token comment"># 是否在http header中添加Vary: Accept-Encoding，建议开启</span>
  <span class="token keyword">gzip_vary</span> on<span class="token punctuation">;</span>

  <span class="token comment"># 禁用IE 6 gzip</span>
  <span class="token keyword">gzip_disable</span> <span class="token string">&quot;MSIE [1-6]\.&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="错误日志"><a href="#错误日志" class="header-anchor">#</a> 错误日志</h3> <p>打开nginx.conf文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> /etc/nginx/nginx.conf
</code></pre></div><h3 id="性能"><a href="#性能" class="header-anchor">#</a> 性能</h3> <p>内容缓存：允许浏览器基本上永久地缓存静态内容。 <code>Nginx</code>将为您设置<code>Expires</code>和<code>Cache-Control</code>头信息。</p> <p>设置nginx的静态文件地址</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control max<span class="token operator">-</span>age<span class="token operator">=</span><span class="token number">360000</span><span class="token punctuation">;</span>
  <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token operator">/</span>webrtc<span class="token operator">-</span>sdk<span class="token operator">/</span>dist<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>设置nginx做websocket代理</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>websocket <span class="token punctuation">{</span>
  <span class="token keyword">proxy_pass</span>         <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.40</span><span class="token number">.174</span><span class="token punctuation">:</span><span class="token number">31089</span><span class="token punctuation">;</span>
  <span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
  <span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
  <span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;Upgrade&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>设置nginx最大打开文件限制</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">user</span> <span class="token keyword">root</span> <span class="token keyword">root</span><span class="token punctuation">;</span>
<span class="token keyword">worker_processes</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">worker_rlimit_nofile</span> <span class="token number">65535</span><span class="token punctuation">;</span>
</code></pre></div><p>设置nginx拦截某个请求，并直接返回状态码</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>p<span class="token operator">/</span>asm <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">204</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>设置nginx给某个路径单独的日志文件</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>p<span class="token operator">/</span>asm <span class="token punctuation">{</span>
  <span class="token keyword">access_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>a<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
  <span class="token keyword">error_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>a<span class="token punctuation">.</span>err<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="警告"><a href="#警告" class="header-anchor">#</a> 警告</h4> <div class="language- extra-class"><pre class="language-text"><code>Starting nginx: nginx: [warn] could not build optimal proxy_headers_hash, you should increase either proxy_headers_hash_max_size: 512 or proxy_headers_hash_bucket_size: 64; ignoring proxy_headers_hash_bucket_size
nginx: [warn] could not build optimal proxy_headers_hash, you should increase either proxy_headers_hash_max_size: 512 or proxy_headers_hash_bucket_size: 64; ignoring proxy_headers_hash_bucket_size
nginx: [warn] could not build optimal proxy_headers_hash, you should increase either proxy_headers_hash_max_size: 512 or proxy_headers_hash_bucket_size: 64;
</code></pre></div><p>在代理中设置</p> <div class="language-conf extra-class"><pre class="language-text"><code>proxy_headers_hash_max_size 51200;
proxy_headers_hash_bucket_size 6400;
</code></pre></div><h3 id="伪静态"><a href="#伪静态" class="header-anchor">#</a> 伪静态</h3> <p>伪静态即是网站本身动态网页，如。php、。asp、。aspx等格式动态网页，加？参数来读取数据库内不同资料，伪静态就是做url重写操作，伪静态最主要的作用是利于seo，</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">rewrite</span> <span class="token function">c</span><span class="token punctuation">(</span>\d<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">.</span>html <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token operator">?</span>c<span class="token operator">=</span><span class="token keyword">user</span><span class="token operator">&amp;</span>id<span class="token operator">=</span>$<span class="token number">1</span><span class="token operator">&amp;</span>title<span class="token operator">=</span>$<span class="token number">2</span> last<span class="token punctuation">;</span>
  <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token operator">/</span>sta<span class="token punctuation">;</span>
  <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm <span class="token keyword">index</span><span class="token punctuation">.</span>php
<span class="token punctuation">}</span>
</code></pre></div><h3 id="资源"><a href="#资源" class="header-anchor">#</a> 资源</h3> <p>Https://xuexb.github.io/learn-nginx</p> <h2 id="caddy"><a href="#caddy" class="header-anchor">#</a> caddy</h2> <p>Caddy 是一个 Go 编写的 Web 服务器，类似于 Nginx，Caddy 提供了更加强大的功能，随着 v2 版本发布 Caddy 已经可以作为中小型站点 Web 服务器的另一个选择；相较于 Nginx 来说使用 Caddy 的优势如下:</p> <ul><li>自动的 HTTPS 证书申请(ACME HTTP/DNS 挑战)</li> <li>自动证书续期以及 OCSP stapling 等</li> <li>更高的安全性包括但不限于 TLS 配置以及内存安全等</li> <li>友好且强大的配置文件支持</li> <li>支持 API 动态调整配置(有木有人可以搞个 Dashboard？)</li> <li>支持 HTTP3(QUIC)</li> <li>支持动态后端，例如连接 Consul、作为 k8s ingress 等</li> <li>后端多种负载策略以及健康检测等</li> <li>本身 Go 编写，高度模块化的系统方便扩展(CoreDNS 基于 Caddy1 开发)</li> <li>……</li></ul> <p>一键安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> https://getcaddy.com <span class="token operator">|</span> <span class="token function">bash</span> -s personal
或者
<span class="token function">wget</span> -qO- https://getcaddy.com <span class="token operator">|</span> <span class="token function">bash</span> -s personal
</code></pre></div><p>检查安装版本</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">which</span> caddy
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f8154061.js" defer></script><script src="/assets/js/2.4cccd600.js" defer></script><script src="/assets/js/42.3f849176.js" defer></script>
  </body>
</html>
