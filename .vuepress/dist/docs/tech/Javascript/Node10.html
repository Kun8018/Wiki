<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NodeJs开发（四）</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.88b3a504.css" as="style"><link rel="preload" href="/assets/js/app.f8154061.js" as="script"><link rel="preload" href="/assets/js/2.4cccd600.js" as="script"><link rel="preload" href="/assets/js/9.58039158.js" as="script"><link rel="prefetch" href="/assets/js/10.54f00d7a.js"><link rel="prefetch" href="/assets/js/11.3da5b74a.js"><link rel="prefetch" href="/assets/js/12.7fee73d6.js"><link rel="prefetch" href="/assets/js/13.76868392.js"><link rel="prefetch" href="/assets/js/14.73742d11.js"><link rel="prefetch" href="/assets/js/15.5f9a7bea.js"><link rel="prefetch" href="/assets/js/16.bc63dc43.js"><link rel="prefetch" href="/assets/js/17.cf9ef8d3.js"><link rel="prefetch" href="/assets/js/18.813f3d8e.js"><link rel="prefetch" href="/assets/js/19.381f5e21.js"><link rel="prefetch" href="/assets/js/20.e6f846bb.js"><link rel="prefetch" href="/assets/js/21.699eb7d8.js"><link rel="prefetch" href="/assets/js/22.9b419f3a.js"><link rel="prefetch" href="/assets/js/23.9e2fcc0f.js"><link rel="prefetch" href="/assets/js/24.c0934c78.js"><link rel="prefetch" href="/assets/js/25.4d32001d.js"><link rel="prefetch" href="/assets/js/26.6a089853.js"><link rel="prefetch" href="/assets/js/27.b32725bd.js"><link rel="prefetch" href="/assets/js/28.a7d1db61.js"><link rel="prefetch" href="/assets/js/29.ee4f84ac.js"><link rel="prefetch" href="/assets/js/3.6608d946.js"><link rel="prefetch" href="/assets/js/30.c1000c38.js"><link rel="prefetch" href="/assets/js/31.694fd1d6.js"><link rel="prefetch" href="/assets/js/32.ac026d3a.js"><link rel="prefetch" href="/assets/js/33.c8ee999f.js"><link rel="prefetch" href="/assets/js/34.6663a77a.js"><link rel="prefetch" href="/assets/js/35.da0b5d07.js"><link rel="prefetch" href="/assets/js/36.75f20762.js"><link rel="prefetch" href="/assets/js/37.df31ffd6.js"><link rel="prefetch" href="/assets/js/38.848c2684.js"><link rel="prefetch" href="/assets/js/39.9a7a0d1a.js"><link rel="prefetch" href="/assets/js/4.9660033f.js"><link rel="prefetch" href="/assets/js/40.ca8e34ae.js"><link rel="prefetch" href="/assets/js/41.ab3f4971.js"><link rel="prefetch" href="/assets/js/42.3f849176.js"><link rel="prefetch" href="/assets/js/43.9b90ce3e.js"><link rel="prefetch" href="/assets/js/44.196181d0.js"><link rel="prefetch" href="/assets/js/45.4ebcccbd.js"><link rel="prefetch" href="/assets/js/46.a68cdba9.js"><link rel="prefetch" href="/assets/js/47.d26979d7.js"><link rel="prefetch" href="/assets/js/48.f6c3543c.js"><link rel="prefetch" href="/assets/js/49.87b9dc0d.js"><link rel="prefetch" href="/assets/js/5.bbf68f26.js"><link rel="prefetch" href="/assets/js/50.0d956d0a.js"><link rel="prefetch" href="/assets/js/51.6d654f81.js"><link rel="prefetch" href="/assets/js/52.180028c6.js"><link rel="prefetch" href="/assets/js/53.688b8ed0.js"><link rel="prefetch" href="/assets/js/54.4760398b.js"><link rel="prefetch" href="/assets/js/55.79d61c82.js"><link rel="prefetch" href="/assets/js/56.22ba5d85.js"><link rel="prefetch" href="/assets/js/57.085d3e52.js"><link rel="prefetch" href="/assets/js/58.a778b7b9.js"><link rel="prefetch" href="/assets/js/59.2ea1a17d.js"><link rel="prefetch" href="/assets/js/6.690811ac.js"><link rel="prefetch" href="/assets/js/60.82c5f4a5.js"><link rel="prefetch" href="/assets/js/61.9851b4bf.js"><link rel="prefetch" href="/assets/js/62.e9ca8158.js"><link rel="prefetch" href="/assets/js/63.44d8baf4.js"><link rel="prefetch" href="/assets/js/64.df339ab2.js"><link rel="prefetch" href="/assets/js/65.ac505688.js"><link rel="prefetch" href="/assets/js/66.3af3b829.js"><link rel="prefetch" href="/assets/js/67.41c1aab0.js"><link rel="prefetch" href="/assets/js/68.5d9e177d.js"><link rel="prefetch" href="/assets/js/69.d3e85f6e.js"><link rel="prefetch" href="/assets/js/7.491a7910.js"><link rel="prefetch" href="/assets/js/70.4494003e.js"><link rel="prefetch" href="/assets/js/71.6e2116c7.js"><link rel="prefetch" href="/assets/js/72.49cda61b.js"><link rel="prefetch" href="/assets/js/73.e7e66ead.js"><link rel="prefetch" href="/assets/js/74.5e98329f.js"><link rel="prefetch" href="/assets/js/75.3dd401e4.js"><link rel="prefetch" href="/assets/js/76.aabec56b.js"><link rel="prefetch" href="/assets/js/77.95564de2.js"><link rel="prefetch" href="/assets/js/78.69634719.js"><link rel="prefetch" href="/assets/js/79.6fcc3d23.js"><link rel="prefetch" href="/assets/js/8.63bf7718.js">
    <link rel="stylesheet" href="/assets/css/0.styles.88b3a504.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p>万万万万万万没想到会来到第七篇，第七篇写Koa框架及Eggjs</p> <h2 id="koa"><a href="#koa" class="header-anchor">#</a> koa</h2> <h3 id="简介-安装"><a href="#简介-安装" class="header-anchor">#</a> 简介/安装</h3> <p>Koa是一个类似于Express的Web开发框架，创始人也是同一个人。它的主要特点是，使用了ES6的Generator函数，进行了架构的重新设计。也就是说，Koa的原理和内部结构很像Express，但是语法和内部结构进行了升级。</p> <p>官方<a href="https://github.com/koajs/koa/blob/master/docs/faq.md#why-isnt-koa-just-express-40" target="_blank" rel="noopener noreferrer">faq<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>有这样一个问题：”为什么koa不是Express 4.0？“，回答是这样的：”Koa与Express有很大差异，整个设计都是不同的，所以如果将Express 3.0按照这种写法升级到4.0，就意味着重写整个程序。所以，我们觉得创造一个新的库，是更合适的做法。“</p> <p>一个Koa应用就是一个对象，包含了一个middleware数组，这个数组由一组Generator函数组成。这些函数负责对HTTP请求进行各种加工，比如生成缓存、指定代理、请求重定向等等。</p> <p>初始化文件夹</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>npm init
</code></pre></div><p>安装koa</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> koa
</code></pre></div><p>最简单的demo</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">ues</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
   ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;我是吴彦祖&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3333</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is running'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="核心概念"><a href="#核心概念" class="header-anchor">#</a> 核心概念</h3> <p>ctx：koa将node的request和response对象封装进ctx，得到ctx.request、cox.response。特别的，ctx将常用的属性做了进一步简化，可以由ctx直接访问，如ctx.request,url可以简化为ctx.request</p> <p>next：next参数将处理的控制权转交下一个中间件，响应结束时再由中间件逐层传递回来，也是著名的洋葱模型</p> <p>request对象：表示HTTP请求。</p> <p>response对象：表示HTTP回应。</p> <p>ctx对象的属性：</p> <ul><li>request：指向Request对象</li> <li>response：指向Response对象</li> <li>req：指向Node的request对象</li> <li>res：指向Node的response对象</li> <li>app：指向App对象</li> <li>state：用于在中间件传递信息。</li></ul> <p>request对象的属性：</p> <p>(1) this.request.header：返回一个对象，包含所有HTTP请求的头信息。也可以写成<code>this.request.headers</code>。</p> <p>(2) this.request.method：返回HTTP请求的方法，该属性可读写。</p> <p>(3)this.request.length:返回HTTP请求的Content-Length属性，取不到值，则返回undefined。</p> <p>(4)this.request.path:返回HTTP请求的路径，该属性可读写。</p> <p>(5)this.request.href:返回HTTP请求的完整路径，包括协议、端口和url。</p> <p>(6)this.request.querystring:返回HTTP请求的查询字符串，不含问号。该属性可读写。</p> <p>(7)this.request.ip:返回发出HTTP请求的IP地址。</p> <p>(8)this.request.fresh:返回一个布尔值，表示缓存是否代表了最新内容。通常与If-None-Match、ETag、If-Modified-Since、Last-Modified等缓存头，配合使用。</p> <p>(9)this.request.query:返回一个对象，包含了HTTP请求的查询字符串。如果没有查询字符串，则返回一个空对象。该属性可读写。</p> <p>(10)this.request.host:返回HTTP请求的主机（含端口号）。</p> <p>(11)this.request.hostname:返回HTTP的主机名（不含端口号）。</p> <p>(12)this.request.search:返回HTTP请求的查询字符串，含问号。该属性可读写。</p> <p>(13)this.request.type:返回HTTP请求的Content-Type属性。</p> <p>(14)this.request.charset:返回HTTP请求的字符集。</p> <p>(15)this.request.protocol:返回HTTP请求的协议，https或者http。</p> <p>(16)this.request.secure:返回一个布尔值，表示当前协议是否为https。</p> <p>(17)this.request.is(types…):返回指定的类型字符串，表示HTTP请求的Content-Type属性是否为指定类型。</p> <p>(18)this.request.accepts(types):检查HTTP请求的Accept属性是否可接受，如果可接受，则返回指定的媒体类型，否则返回false。</p> <p>(19)this.request.acceptsEncodings(encodings):该方法根据HTTP请求的Accept-Encoding字段，返回最佳匹配，如果没有合适的匹配，则返回false。</p> <p>(20)this.request.acceptsCharsets(charsets):该方法根据HTTP请求的Accept-Charset字段，返回最佳匹配，如果没有合适的匹配，则返回false。</p> <p>(21)this.request.acceptsLanguages(langs):该方法根据HTTP请求的Accept-Language字段，返回最佳匹配，如果没有合适的匹配，则返回false。</p> <p>(22)this.request.socket:返回HTTP请求的socket。</p> <p>(23)this.request.get(field):返回HTTP请求指定的字段。</p> <p>response对象的属性：</p> <p>(1)this.response.header：返回HTTP回应的头信息。</p> <p>(2)this.response.socket：返回HTTP回应的socket。</p> <p>(3)this.response.status:返回HTTP回应的状态码。默认情况下，该属性没有值。该属性可读写，设置时等于一个整数。</p> <p>(4)this.response.message：返回HTTP回应的状态信息。该属性与<code>this.response.message</code>是配对的。该属性可读写。</p> <p>(5)this.response.length:返回HTTP回应的Content-Length字段。该属性可读写，如果没有设置它的值，koa会自动从this.request.body推断。</p> <p>(6)this.response.body: 返回HTTP回应的信息体。该属性可读写，它的值可能有以下几种类型。</p> <p>字符串：Content-Type字段默认为text/html或text/plain，字符集默认为utf-8，Content-Length字段同时设定。
二进制Buffer：Content-Type字段默认为application/octet-stream，Content-Length字段同时设定。
Stream：Content-Type字段默认为application/octet-stream。
JSON对象：Content-Type字段默认为application/json。
null（表示没有信息体）</p> <p>(7)this.response.get(field):返回HTTP回应的指定字段。</p> <p>(8)this.response.set():设置HTTP回应的指定字段。</p> <p>(9)this.response.remove(field):移除HTTP回应的指定字段。</p> <p>(10)this.response.is(types…):该方法类似于<code>this.request.is()</code>，用于检查HTTP回应的类型是否为支持的类型。</p> <p>它可以在中间件中起到处理不同格式内容的作用。</p> <p>(11)this.response.redirect(url, [alt]):该方法执行302跳转到指定网址。如果redirect方法的第一个参数是back，将重定向到HTTP请求的Referrer字段指定的网址，如果没有该字段，则重定向到第二个参数或“/”网址。</p> <p>(12)this.response.attachment([filename]):该方法将HTTP回应的Content-Disposition字段，设为“attachment”，提示浏览器下载指定文件。</p> <p>(13)this.response.headerSent：该方法返回一个布尔值，检查是否HTTP回应已经发出。</p> <p>(14)this.response.lastModified：该属性以Date对象的形式，返回HTTP回应的Last-Modified字段（如果该字段存在）。该属性可写。</p> <p>(15)this.response.etag:该属性设置HTTP回应的ETag字段。</p> <p>(16)this.response.vary(field):该方法将参数添加到HTTP回应的Vary字段。</p> <h3 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h3> <p>Koa的中间件很像Express的中间件，也是对HTTP请求进行处理的函数，但是必须是一个Generator函数。而且，Koa的中间件是一个级联式（Cascading）的结构，也就是说，属于是层层调用，第一个中间件调用第二个中间件，第二个调用第三个，以此类推。上游的中间件必须等到下游的中间件返回结果，才会继续执行，这点很像递归。</p> <p>中间件通过当前应用的use方法注册。</p> <p><code>app.use</code>方法的参数就是中间件，它是一个Generator函数，最大的特征就是function命令与参数之间，必须有一个星号。Generator函数的参数next，表示下一个中间件。</p> <h3 id="洋葱模型"><a href="#洋葱模型" class="header-anchor">#</a> 洋葱模型</h3> <p>实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//打印时间戳</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;next前，打印时间戳:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;next后，打印时间戳:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//打印路由</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;next前，打印url:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;next后，打印url:&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//使用中间件</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> logTime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/logTime'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> logUrl <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/logUrl'</span><span class="token punctuation">)</span>

<span class="token comment">// logTime</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// logUrl</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// response</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="源码koa-compose"><a href="#源码koa-compose" class="header-anchor">#</a> 源码koa-compose</h4> <p>koa中比较重要的点：</p> <ol><li>context的保存和传递</li> <li>中间件的管理和next的实现</li></ol> <p>1.app.listen使用了this.callback()来生成node的httpServer的回调函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'listen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>中间件引擎</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 核心：中间件的管理和next的实现</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">listeners</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token function-variable function">handleRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建ctx</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> handleRequest<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用compose函数处理中间件。compose中有<code>dispatch</code>函数，它将遍历整个<code>middleware</code>，然后将<code>context</code>和<code>dispatch(i + 1)</code>传给<code>middleware</code>中的方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">compose</span> <span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// last called middleware #</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    <span class="token keyword">function</span> <span class="token function">dispatch</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> index<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'next() called multiple times'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      index <span class="token operator">=</span> i
      <span class="token keyword">let</span> fn <span class="token operator">=</span> middleware<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> middleware<span class="token punctuation">.</span>length<span class="token punctuation">)</span> fn <span class="token operator">=</span> next
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">next</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h3> <p>使用koa-router处理URL</p> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i koa-router --save 
</code></pre></div><p>实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>

<span class="token comment">//写法1，一个路由对象</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'index页'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'index页'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3333</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server is running&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//写法2，建立不同路由对象然后一起装载,嵌套路由</span>
<span class="token keyword">let</span> oneRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> twoRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

oneRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
   ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;onerouter 页&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

twoRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
   ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'tworouter页'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
   ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'home页'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> indexRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
indexRouter<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/one'</span><span class="token punctuation">,</span>oneRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>oneRouter<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
indexRouter<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/two'</span><span class="token punctuation">,</span>twoRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>twoRouter<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>indexRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>indexRouter<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3333</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="处理请求"><a href="#处理请求" class="header-anchor">#</a> 处理请求</h3> <p>使用koa-router处理请求，如get、post</p> <p>post请求使用koa-bodyparser处理body中的数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i koa-bodyparser --save
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Router<span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">require</span> <span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//get请求</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/data'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span> ctx<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
  
  <span class="token keyword">let</span> data <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">;</span><span class="token comment">//查询的的对象</span>
  <span class="token keyword">let</span> dataQuery <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>querystring<span class="token punctuation">;</span> <span class="token comment">// 查询的字符串</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//restful风格api，get请求</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'data/:id'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
   <span class="token keyword">let</span> data <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//post请求</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post/result'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span>num<span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">&amp;&amp;</span> num <span class="token punctuation">)</span><span class="token punctuation">{</span>
     ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;${name} ${num}&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="日志"><a href="#日志" class="header-anchor">#</a> 日志</h3> <h3 id="koa-logger"><a href="#koa-logger" class="header-anchor">#</a> koa-logger</h3> <p>这个库比较简单，记录请求的基本信息，比如请求的方法、URl、用时等。作为中间件中使用，注意：推荐放在所有的中间件之前，这个跟 koa 的洋葱模型有关。假如不是第一个，计算时间会不准确。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-logger'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>默认情况下，日志是通过 <code>console</code> 的方式直接输出到控制台中，假如我们需要对日志做自定义的操作，比如写入到日志文件中等。可以通过类似完成</p> <h3 id="koa-log4js"><a href="#koa-log4js" class="header-anchor">#</a> koa-log4js</h3> <p><code>koa-logger</code> 比较轻量，也暴露了相对灵活的接口。但在实际业务中使用，我个人推荐使用 <code>koa-log4js</code>。主要理由如下：</p> <ul><li><code>koa-logger</code> 看起来只支持中间件的使用方式，而不支持上报特定日志的功能。</li> <li>内置的功能比较少。比如日志的分类和落盘等。</li></ul> <p><strong>koa-log4js</strong>[2] 对 <strong>log4js-node</strong>[3] 做了一层包装，从而支持 <code>Koa</code> 日志的中间件。它的配置和 <code>log4js-node</code> 是保持一致的。所以假如你用 <code>log4js-node</code> 的话，使用上应该是一致的。</p> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i --save koa-log4
</code></pre></div><p>在根目录新建一个文件夹 <code>log</code>。并且新建一个文件夹 <code>utils</code>，在其中新建文件 <code>logger.js</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-log4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">RUNTIME_PATH</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">LOG_PATH</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token constant">RUNTIME_PATH</span><span class="token punctuation">,</span> <span class="token string">'log'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 日志的输出</span>
  appenders<span class="token operator">:</span> <span class="token punctuation">{</span>
    access<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'dateFile'</span><span class="token punctuation">,</span>
      pattern<span class="token operator">:</span> <span class="token string">'-yyyy-MM-dd.log'</span><span class="token punctuation">,</span> <span class="token comment">//生成文件的规则</span>
      alwaysIncludePattern<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 文件名始终以日期区分</span>
      encoding<span class="token operator">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token constant">LOG_PATH</span><span class="token punctuation">,</span> <span class="token string">'access.log'</span><span class="token punctuation">)</span> <span class="token comment">//生成文件名</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    application<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'dateFile'</span><span class="token punctuation">,</span>
      pattern<span class="token operator">:</span> <span class="token string">'-yyyy-MM-dd.log'</span><span class="token punctuation">,</span>
      alwaysIncludePattern<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      encoding<span class="token operator">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token constant">LOG_PATH</span><span class="token punctuation">,</span> <span class="token string">'application.log'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    out<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'console'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  categories<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> appenders<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'out'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token string">'info'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    access<span class="token operator">:</span> <span class="token punctuation">{</span> appenders<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'access'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token string">'info'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    application<span class="token operator">:</span> <span class="token punctuation">{</span> appenders<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'application'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// getLogger 传参指定的是类型</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">accessLogger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> log4js<span class="token punctuation">.</span><span class="token function">koaLogger</span><span class="token punctuation">(</span>log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'access'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录所有访问级别的日志</span>
exports<span class="token punctuation">.</span>logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'application'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>categories配置日志类别。必须配置默认日志类别，用于没有命中的情况下的兜底行为。该配置为一个对象，<code>key</code> 值为分类名称。其中每个类别都有两个配置 <code>appenders</code> 是一个字符串数组，是输出配置（后文中会详解），可以指定多个，至少要有一个。<code>level</code> 是上文日志级别。</p> <p><code>appenders</code>配置输出日志，该配置的 <code>key</code> 值为自定义的名称（可以给 <code>categories</code> 中的 <code>appenders</code> 使用），属性值为一个对象，配置输出类型。<code>out</code> 指的是通过 <code>console</code> 输出，这个可以作为我们的一个兜底。<code>access</code> 中 <code>type</code> 为 <code>dataFile</code>，指的是输出文件，然后配置文件的命名和输出路径。</p> <p>在 <code>app.js</code> 以及<code>routes/index.js</code> 中加入：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> accessLogger<span class="token punctuation">,</span> logger <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/logger'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">accessLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// routes/index.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> logger <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/logger'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'我是首页'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'Hello Koa 2!'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>可以看到在 <code>log</code> 文件夹中输出两个文件：access-log和application-log两个日志文件</p> <p>日志的分级，主要作用是更好的展示日志（不同颜色）、有选择的落盘日志，比如在生产中避免一些 <code>debug</code> 的敏感日志被泄露。<code>log4js-node</code> 默认有九个分级（你可以通过 <code>levels</code> 进行修改）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token constant">ALL</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Level</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">,</span> <span class="token string">&quot;ALL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">TRACE</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Level</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">,</span> <span class="token string">&quot;TRACE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">DEBUG</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Level</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">&quot;DEBUG&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">INFO</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Level</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token string">&quot;INFO&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">WARN</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Level</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">,</span> <span class="token string">&quot;WARN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">ERROR</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Level</span><span class="token punctuation">(</span><span class="token number">40000</span><span class="token punctuation">,</span> <span class="token string">&quot;ERROR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">FATAL</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Level</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">,</span> <span class="token string">&quot;FATAL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">MARK</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Level</span><span class="token punctuation">(</span><span class="token number">9007199254740992</span><span class="token punctuation">,</span> <span class="token string">&quot;MARK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 2^53</span>
  <span class="token constant">OFF</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Level</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span> <span class="token string">&quot;OFF&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>默认只会输出级别相等或者级别高的日志。比如你配置了 <code>WARN</code>，就不会输出 <code>INFO</code> 的日志。可以在下面配置的 <code>categories</code> 中配置不同的类型日志的日志级别。</p> <h3 id="cookie、session操作koa-session"><a href="#cookie、session操作koa-session" class="header-anchor">#</a> cookie、session操作koa-session</h3> <p>koa可以直接操作cookie</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post/result'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
		<span class="token keyword">let</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span>num<span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">&amp;&amp;</span> num <span class="token punctuation">)</span><span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;${name} ${num}&quot;</span>
      ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
        <span class="token string">'xunleiCode'</span><span class="token punctuation">,</span>num<span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          domain<span class="token operator">:</span><span class="token string">'localhost'</span><span class="token punctuation">,</span>  <span class="token comment">//写cookie所在的域名</span>
          path<span class="token operator">:</span><span class="token string">'/post/result'</span><span class="token punctuation">,</span>  <span class="token comment">//写cookie所在的路径</span>
          maxAge<span class="token operator">:</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">//cookie有效时长</span>
          expires<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2018-09-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//cookie失效时间</span>
          httpOnly<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//是否只用于http请求中获取</span>
          overwrite： <span class="token boolean">false</span>， <span class="token comment">//是否允许重写</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>安装koa-session</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>npm i koa<span class="token operator">-</span>session
</code></pre></div><p>实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-session'</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'some secret hurr'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  key<span class="token operator">:</span><span class="token string">&quot;koa:sess&quot;</span><span class="token punctuation">,</span>  <span class="token comment">//默认cookie为koa：sess</span>
  maxAge<span class="token operator">:</span> <span class="token number">86400000</span><span class="token punctuation">,</span><span class="token comment">// 过期时间，默认为1天</span>
  overwrite<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否可以重写</span>
  httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">//cookie是否只有服务端可以访问</span>
  signed<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>     <span class="token comment">//签名默认为true</span>
  rolling<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>   <span class="token comment">//在每次请求时重新设置cookie，重置cookie过期时间</span>
  renew<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>     <span class="token comment">//刷新session当session接近失效</span>
<span class="token punctuation">}</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">,</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="csrf攻击koa-csrf"><a href="#csrf攻击koa-csrf" class="header-anchor">#</a> CSRF攻击koa-csrf</h3> <p>CSRF攻击是指用户的session被劫持，用来冒充用户的攻击。</p> <p>koa-csrf插件用来防止CSRF攻击。原理是在session之中写入一个秘密的token，用户每次使用POST方法提交数据的时候，必须含有这个token，否则就会抛出错误。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> csrf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-csrf'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> route <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-route'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'session key'</span><span class="token punctuation">,</span> <span class="token string">'csrf example'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">token</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>csrf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>ok<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>POST请求含有token，可以是以下几种方式之一，koa-csrf插件就能获得token。</p> <ul><li>表单的_csrf字段</li> <li>查询字符串的_csrf字段</li> <li>HTTP请求头信息的x-csrf-token字段</li> <li>HTTP请求头信息的x-xsrf-token字段</li></ul> <h3 id="数据压缩koa-compress"><a href="#数据压缩koa-compress" class="header-anchor">#</a> 数据压缩koa-compress</h3> <p>koa-compress模块可以实现数据压缩。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-compress'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/plain'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'filename.txt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="koa-connect"><a href="#koa-connect" class="header-anchor">#</a> koa-connect</h3> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> koa-connect
</code></pre></div><p>使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> k2c <span class="token keyword">from</span> <span class="token string">'koa2-connect'</span>
<span class="token keyword">import</span> httpProxy <span class="token keyword">from</span> <span class="token string">'http-proxy-middleware'</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">proxyHandler</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token operator">:</span>Context<span class="token punctuation">,</span>next<span class="token operator">:</span>any</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> nebulaProxy <span class="token operator">=</span> <span class="token function">k2c</span><span class="token punctuation">(</span>
    <span class="token function">httpProxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      target<span class="token operator">:</span> <span class="token string">'http://localhost:8000'</span><span class="token punctuation">,</span>
      pathRewrite<span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">'/api-nebula'</span><span class="token operator">:</span><span class="token string">'/api'</span>
      <span class="token punctuation">}</span>
      changeOrigin<span class="token operator">:</span> True<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="源码"><a href="#源码" class="header-anchor">#</a> 源码</h3> <p>koa2有四个核心文件：application.js、context.js、request.js、response.js。</p> <p>application.js：application.js是koa的入口文件，它向外导出了创建class实例的构造函数，它继承了events，这样就会赋予框架事件监听和事件触发的能力。application还暴露了一些常用的api，比如toJSON、listen、use等等。</p> <p>Context.js：这部分就是koa的应用上下文ctx,其实就一个简单的对象暴露，里面的重点在delegate，这个就是代理，这个就是为了开发者方便而设计的，比如我们要访问ctx.repsponse.status但是我们通过delegate，可以直接访问ctx.status访问到它。</p> <p>Request.js、Response.js ： 这两部分就是对原生的res、req的一些操作了，大量使用es6的get和set的一些语法，去取headers或者设置headers、还有设置body等等</p> <p>基于此，如果要实现koa框架需要四个模块：</p> <ul><li>封装node http server、创建Koa类构造函数</li> <li>构造request、response、context对象</li> <li>中间件机制和剥洋葱模型的实现</li> <li>错误捕获和错误处理</li></ul> <h3 id="资源"><a href="#资源" class="header-anchor">#</a> 资源</h3> <p>koa资源库：https://github.com/huaize2020/awesome-koa</p> <p>https://github.com/airuikun/blog/issues/2</p> <h2 id="eggjs"><a href="#eggjs" class="header-anchor">#</a> eggjs</h2> <p>web应用离不开session、视图模版、路由、文件上传、日志管理，这些koa都不提供，需要自行去官方的中间件网站去找，100个人可能有100种搭配</p> <p>而eggjs是基于koajs，解决了上述问题，将社区最佳实践整合进koajs，并且将多进程启动、开发时的热更新等问题一并解决，对开发者很友好，开箱即是最佳/较佳配置</p> <h3 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h3> <p><code>app/router.js</code>:用于配置URL路由规则</p> <p><code>app/controller/**</code>:用于解析用户的输入，处理返回相应的结果</p> <p><code>app/service/**</code>:用于编写业务逻辑层，可选</p> <p><code>app/middleware/**</code>:用于编写中间件，</p> <p><code>app/public/**</code>:用于放置静态资源</p> <p><code>app/extend/**</code>:用于框架的扩展</p> <p><code>config/config.{env}.js</code>:用于编写配置文件</p> <p><code>config/plugin.js</code>:用于配置需要加载的文件</p> <p><code>test/**</code>:用于单元测试</p> <p><code>app.js</code>和<code>agent.js</code>:用于自定义的初始化工作</p> <h3 id="内置对象"><a href="#内置对象" class="header-anchor">#</a> 内置对象</h3> <p>eggjs继承了koa的application、context、request、response对象，并且扩展了一些新的全局对象，controller、service、logger、config、helper</p> <p>每个controller下面都有以下属性：</p> <p>ctx：当前请求的context实例</p> <p>app：应用的application实例</p> <p>config：应用的配置</p> <p>service：应用所有的service</p> <p>logger：为当前controller封装的logger对象</p> <p>推荐从egg对象上获取controller基类，也可以从app实例上获取</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//从egg上获取</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller
<span class="token keyword">class</span> <span class="token class-name">USerController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span>
<span class="token comment">//从app上获取</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">app<span class="token punctuation">.</span>controller</span><span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Service基类与controller基类基本相同，获取方式也相同</p> <h3 id="路由router"><a href="#路由router" class="header-anchor">#</a> 路由Router</h3> <p>Router的请求用来描述URL与具体承担执行动作的controller的关系，框架约定了<code>app/router.js</code>文件用于统一所有路由规则</p> <p>路由定义时需指定：</p> <p>1.请求方法/请求动作，包括head、options、get、post、delete、put、patch、redirect等</p> <p>2.路由名称，给路由设定一个别名</p> <p>3.中间件，在router里可以配置多个中间件，<strong>串联执行</strong></p> <p>4.控制器，指定路由映射到具体到控制器上</p> <p>特别地，Restful风格的CRUD的路由配置如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span>controller<span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
   router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'posts'</span><span class="token punctuation">,</span><span class="token string">'/api/posts'</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>posts<span class="token punctuation">)</span><span class="token punctuation">;</span>
   router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span><span class="token string">'/api/v1/users'</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>users<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="控制器controller"><a href="#控制器controller" class="header-anchor">#</a> 控制器controller</h3> <p>控制器与路由对应，实现控制器的服务</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>router<span class="token punctuation">,</span>controller<span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//controller,user.js</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="服务-service"><a href="#服务-service" class="header-anchor">#</a> 服务(service)</h3> <p>service是复杂场景下用于做业务逻辑封装的一个抽象层，有利于：</p> <p>1.保持controller的逻辑更加简洁</p> <p>2.保持业务逻辑的独立性，抽象出来的service可以被多个controller重复调用</p> <p>3.将逻辑与展现分离，更容易编写测试用例</p> <p>使用场景：</p> <p>复杂数据的处理，如需要查数据库、按一定规则计算或者计算完成之后更新到数据库</p> <p>调用第三方的服务时</p> <p>定义service</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//app/service/user.js</span>
<span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service

Class UserService <span class="token keyword">extends</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>
   <span class="token keyword">async</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'select * from user where uid = ?'</span><span class="token punctuation">,</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> user<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserService
</code></pre></div><p>在controller中调用对应的service</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> userId <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span>
</code></pre></div><h3 id="中间件-2"><a href="#中间件-2" class="header-anchor">#</a> 中间件</h3> <p>我们约定中间件是一个放置在<code>app/middleware</code>目录下的单独文件，它接受两个参数，</p> <p>Options:中间件的配置，框架会将config传递进来</p> <p>app:当前应用application的实例</p> <p>中间件实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//app/middleware/gzip.js</span>
<span class="token keyword">const</span> isJSON <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-js-json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> zli <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'zlib'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">options</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">gzip</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>body<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> stream <span class="token operator">=</span> zlib<span class="token punctuation">.</span><span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> stream<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Encoding'</span><span class="token punctuation">,</span><span class="token string">'gzip'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在单个router中或者全局实例化和挂载</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//单个路由加载</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> gzip <span class="token operator">=</span> app<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">gzip</span><span class="token punctuation">(</span><span class="token punctuation">{</span> threshold<span class="token operator">:</span><span class="token number">1024</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/needgzip'</span><span class="token punctuation">,</span>gzip<span class="token punctuation">,</span>app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>全局加载</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  middleware<span class="token operator">:</span><span class="token punctuation">[</span>gzip<span class="token punctuation">]</span><span class="token punctuation">,</span>
  gzip<span class="token operator">:</span><span class="token punctuation">{</span>
    threshold<span class="token operator">:</span><span class="token number">1024</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="插件"><a href="#插件" class="header-anchor">#</a> 插件</h3> <p>koa的中间件系统有其固有的缺点：</p> <p>1.中间件的顺序不可固定，使用先后顺序的不同，结果可能有天壤之别</p> <p>2.有些功能是与请求无关的，如定时任务、消息订阅，中间件处理起来麻烦</p> <p>3.初始化逻辑复杂，需要在应用启动的时候完成</p> <p>一个插件就像一个mini的应用，有service，中间件，配置等，没有路由和controller，没有plugin</p> <p>插件一般提供npm的方式安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i egg-mysql --save
</code></pre></div><p>在package.json中引入依赖</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;egg-mysql&quot;</span><span class="token operator">:</span><span class="token string">&quot;^3.0.0&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在plugin.js中声明</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span>mysql <span class="token operator">=</span> <span class="token punctuation">{</span>
  enable<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">package</span><span class="token operator">:</span><span class="token string">'egg-dev'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="上传文件"><a href="#上传文件" class="header-anchor">#</a> 上传文件</h3> <p>config</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>config<span class="token punctuation">.</span>multipart <span class="token operator">=</span> <span class="token punctuation">{</span>
  fileSize<span class="token operator">:</span> <span class="token string">'50mb'</span><span class="token punctuation">,</span>
  mode<span class="token operator">:</span> <span class="token string">'stream'</span><span class="token punctuation">,</span>
  fileExtensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'xls'</span><span class="token punctuation">,</span><span class="token string">'.txt'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> await-stream-ready stream-wormhole dayjs
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">requrie</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> awaitWriteStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'await-stream-ready'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">;</span>


</code></pre></div><h3 id="定时任务"><a href="#定时任务" class="header-anchor">#</a> 定时任务</h3> <p>有一些任务是需要定时运行的，比如</p> <p>1.定时上报任务状态</p> <p>2.定时从远程接口更新本地缓存</p> <p>3.定时进行文件切割、文件删除等</p> <p>所有的定时任务放在<code>app/schedule</code>目录下，每一个文件都是独立的定时任务，可以配置定时任务的属性和要执行的方法</p> <p>比如，定义一个更新远程数据到内存缓存的定时任务</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//app/schedule/update_cache.js</span>
<span class="token keyword">const</span> Subscription <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Subscription

<span class="token keyword">class</span> <span class="token class-name">UpdayeCache</span> <span class="token keyword">extends</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      interval<span class="token operator">:</span><span class="token string">'1m'</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span><span class="token string">'all'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">async</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'http://www.api.com/cache'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
      dataType<span class="token operator">:</span> <span class="token string">'json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>cache <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UpdateCache<span class="token punctuation">;</span>
</code></pre></div><h3 id="多进程模型与进程间通信"><a href="#多进程模型与进程间通信" class="header-anchor">#</a> 多进程模型与进程间通信</h3> <p>Node官方提供了cluster模块，用于多核计算</p> <p>原生的Node-cluster特点：</p> <p>在服务器上同时启动多个进程；</p> <p>每个进程都跑同一份源代码，</p> <p>更神奇的是，这些进程可以同时监听同一个端口，</p> <p>其中，负责启动其他进程的叫做Master进程，他好比是包工头，不做具体的工作，只负责启动其他进程</p> <p>其他被启动的叫Worker进程，就是干活的工人，它们接收请求，对外提供服务</p> <p>Worker进程的数量一般由服务器的CPU核数决定，这样可以完美利用多核资源</p> <p>egg在此基础上进行了别的考虑：</p> <p>进程崩溃</p> <p>work异常退出时如何处理？多个worker进程之间如何共享资源和调度？</p> <p>Nodejs进程退出可以分为两类：</p> <p>1是代码抛出了异常但未被捕获，进程将会退出。当一个worker进程遇到未捕获的异常时，它已经处于一个不确定状态，我们应该让这个进程优雅退出：</p> <p>关闭异常worker进程的所有tcp server。断开和Master的IPC通道，不再接受新的用户请求</p> <p>Master立刻fork一个进行中的worker进程，保证在线的工人总数不变</p> <p>异常worker等待一段时间，处理完已经接受的请求之后退出</p> <p>2是进程崩溃或者系统异常，不像未捕获异常时，当前进程直接退出，Master直接fork一个新的worker</p> <p>进程守护</p> <p>有些工作不需要每个worker都去做，如果都做，一来是浪费资源，更重要的是可能会导致多进程间资源访问冲突。</p> <p>对于这一类后台运行逻辑，全部放到一个单独的进程去执行，这个进程就叫做Agent Worker。Agent就好比Master给其他Worker请的一个秘书，它不对外提供服务，只给App Worker打工，专门处理一些公共事务。</p> <p>所以框架启动时进程的启动顺序就会变成：</p> <p>1.master启动后先fork Agent进程</p> <p>2.Agent初始化成功之后，通过IPC通道通知Master</p> <p>3.Master再fork多个App worker</p> <p>4.App Worker初始化成功，通知Master</p> <p>5.所有进程初始化成功后，Master通知Agent和Worker启动成功</p> <p>进程通信</p> <p>虽然每个Worker进程是相对独立的，但是它们之间始终还是需要通讯的，称为IPC通讯。</p> <p>Node cluster提供的IPC通道只存在于Master和Worker/Agent之间，Worker之间、Worker与Agent之间是没有的，要想相互通信只能通过master转发，这是不太方便的</p> <p>Egg封装了messenger对象挂载在app/agent上，能够相互通信</p> <p>方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">sendToApp</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">sendToAgent</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
agent<span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">sendRandom</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
agent<span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">sendTo</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>action<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
</code></pre></div><h3 id="日志-2"><a href="#日志-2" class="header-anchor">#</a> 日志</h3> <h2 id="midwayjs"><a href="#midwayjs" class="header-anchor">#</a> midwayjs</h2></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f8154061.js" defer></script><script src="/assets/js/2.4cccd600.js" defer></script><script src="/assets/js/9.58039158.js" defer></script>
  </body>
</html>
