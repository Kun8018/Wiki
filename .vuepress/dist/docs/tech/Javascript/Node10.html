<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NodeJs开发（二）</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.0503e0f3.css" as="style"><link rel="preload" href="/assets/js/app.3979e060.js" as="script"><link rel="preload" href="/assets/js/2.0f8cbb55.js" as="script"><link rel="preload" href="/assets/js/1.ff82b27c.js" as="script"><link rel="preload" href="/assets/js/26.3764ddb4.js" as="script"><link rel="prefetch" href="/assets/js/10.d9850768.js"><link rel="prefetch" href="/assets/js/100.a33654f4.js"><link rel="prefetch" href="/assets/js/101.d3bc1c79.js"><link rel="prefetch" href="/assets/js/102.02bbfd1e.js"><link rel="prefetch" href="/assets/js/103.c9de5560.js"><link rel="prefetch" href="/assets/js/104.7c2b76db.js"><link rel="prefetch" href="/assets/js/105.ea3ac79c.js"><link rel="prefetch" href="/assets/js/106.d54e3045.js"><link rel="prefetch" href="/assets/js/107.c142f695.js"><link rel="prefetch" href="/assets/js/108.fe2c9c19.js"><link rel="prefetch" href="/assets/js/109.59b55101.js"><link rel="prefetch" href="/assets/js/11.62caceeb.js"><link rel="prefetch" href="/assets/js/110.c657b6f8.js"><link rel="prefetch" href="/assets/js/111.4eadf9c5.js"><link rel="prefetch" href="/assets/js/112.fce38ecf.js"><link rel="prefetch" href="/assets/js/113.ee6322e2.js"><link rel="prefetch" href="/assets/js/114.1ed20fd8.js"><link rel="prefetch" href="/assets/js/115.aa405ee0.js"><link rel="prefetch" href="/assets/js/116.d1b4c413.js"><link rel="prefetch" href="/assets/js/117.965d1926.js"><link rel="prefetch" href="/assets/js/118.b1d5b9ca.js"><link rel="prefetch" href="/assets/js/119.e4e766bc.js"><link rel="prefetch" href="/assets/js/12.abd8d9de.js"><link rel="prefetch" href="/assets/js/120.f569b061.js"><link rel="prefetch" href="/assets/js/121.e3915f79.js"><link rel="prefetch" href="/assets/js/122.3a2b3d34.js"><link rel="prefetch" href="/assets/js/123.cbf985ea.js"><link rel="prefetch" href="/assets/js/124.c3d8b6fc.js"><link rel="prefetch" href="/assets/js/125.dfe970a3.js"><link rel="prefetch" href="/assets/js/126.f5165054.js"><link rel="prefetch" href="/assets/js/127.ffb31d35.js"><link rel="prefetch" href="/assets/js/128.bf7eb0b3.js"><link rel="prefetch" href="/assets/js/129.76b0ac54.js"><link rel="prefetch" href="/assets/js/13.763c094c.js"><link rel="prefetch" href="/assets/js/130.cb661ef6.js"><link rel="prefetch" href="/assets/js/131.b215b4cc.js"><link rel="prefetch" href="/assets/js/132.bdf6b89f.js"><link rel="prefetch" href="/assets/js/133.a13e43ca.js"><link rel="prefetch" href="/assets/js/134.f858c56e.js"><link rel="prefetch" href="/assets/js/135.0e05a297.js"><link rel="prefetch" href="/assets/js/136.ff47beeb.js"><link rel="prefetch" href="/assets/js/137.7dcf182f.js"><link rel="prefetch" href="/assets/js/138.dd2c3c8c.js"><link rel="prefetch" href="/assets/js/139.db36e4eb.js"><link rel="prefetch" href="/assets/js/14.784100b6.js"><link rel="prefetch" href="/assets/js/140.05811a56.js"><link rel="prefetch" href="/assets/js/141.32b8052b.js"><link rel="prefetch" href="/assets/js/142.2c061186.js"><link rel="prefetch" href="/assets/js/143.113df61a.js"><link rel="prefetch" href="/assets/js/144.2c01c336.js"><link rel="prefetch" href="/assets/js/145.a8fe7a8a.js"><link rel="prefetch" href="/assets/js/146.bb5b7e16.js"><link rel="prefetch" href="/assets/js/147.213b17a7.js"><link rel="prefetch" href="/assets/js/148.dd7a3258.js"><link rel="prefetch" href="/assets/js/149.b3f9adc5.js"><link rel="prefetch" href="/assets/js/15.3aa73286.js"><link rel="prefetch" href="/assets/js/150.4ab9a505.js"><link rel="prefetch" href="/assets/js/151.d04eb475.js"><link rel="prefetch" href="/assets/js/152.c547ae2c.js"><link rel="prefetch" href="/assets/js/153.3fa58002.js"><link rel="prefetch" href="/assets/js/154.cd2cc012.js"><link rel="prefetch" href="/assets/js/155.0160c441.js"><link rel="prefetch" href="/assets/js/16.7886627b.js"><link rel="prefetch" href="/assets/js/17.a4c76a6c.js"><link rel="prefetch" href="/assets/js/18.995eb54b.js"><link rel="prefetch" href="/assets/js/19.edc682a7.js"><link rel="prefetch" href="/assets/js/20.87ca556d.js"><link rel="prefetch" href="/assets/js/21.4b328dcc.js"><link rel="prefetch" href="/assets/js/22.91d15e78.js"><link rel="prefetch" href="/assets/js/23.17bfc3dd.js"><link rel="prefetch" href="/assets/js/24.c0d84a10.js"><link rel="prefetch" href="/assets/js/25.2717e191.js"><link rel="prefetch" href="/assets/js/27.e98913ec.js"><link rel="prefetch" href="/assets/js/28.a4481108.js"><link rel="prefetch" href="/assets/js/29.3d82d38d.js"><link rel="prefetch" href="/assets/js/3.e2aae122.js"><link rel="prefetch" href="/assets/js/30.7e9979a2.js"><link rel="prefetch" href="/assets/js/31.fa479c29.js"><link rel="prefetch" href="/assets/js/32.901576de.js"><link rel="prefetch" href="/assets/js/33.8dafc45c.js"><link rel="prefetch" href="/assets/js/34.6bbddd9b.js"><link rel="prefetch" href="/assets/js/35.394c80b9.js"><link rel="prefetch" href="/assets/js/36.5246333d.js"><link rel="prefetch" href="/assets/js/37.49802bfd.js"><link rel="prefetch" href="/assets/js/38.36ae0914.js"><link rel="prefetch" href="/assets/js/39.791184a0.js"><link rel="prefetch" href="/assets/js/4.30c2ba05.js"><link rel="prefetch" href="/assets/js/40.eb1a9cc1.js"><link rel="prefetch" href="/assets/js/41.31179942.js"><link rel="prefetch" href="/assets/js/42.22c31ea4.js"><link rel="prefetch" href="/assets/js/43.e82e343d.js"><link rel="prefetch" href="/assets/js/44.95e68751.js"><link rel="prefetch" href="/assets/js/45.b99232d2.js"><link rel="prefetch" href="/assets/js/46.21e9dae9.js"><link rel="prefetch" href="/assets/js/47.e30bba7c.js"><link rel="prefetch" href="/assets/js/48.6c0d14cd.js"><link rel="prefetch" href="/assets/js/49.ed1b480b.js"><link rel="prefetch" href="/assets/js/5.c5fba3ad.js"><link rel="prefetch" href="/assets/js/50.f500b9ed.js"><link rel="prefetch" href="/assets/js/51.3671246f.js"><link rel="prefetch" href="/assets/js/52.7915148f.js"><link rel="prefetch" href="/assets/js/53.39ece5d9.js"><link rel="prefetch" href="/assets/js/54.358ca4aa.js"><link rel="prefetch" href="/assets/js/55.244837be.js"><link rel="prefetch" href="/assets/js/56.e7164f10.js"><link rel="prefetch" href="/assets/js/57.3c6f5aa2.js"><link rel="prefetch" href="/assets/js/58.84c83603.js"><link rel="prefetch" href="/assets/js/59.ec4edc7d.js"><link rel="prefetch" href="/assets/js/6.9184d4d1.js"><link rel="prefetch" href="/assets/js/60.c2346e02.js"><link rel="prefetch" href="/assets/js/61.8d99ca4c.js"><link rel="prefetch" href="/assets/js/62.f6bea4bf.js"><link rel="prefetch" href="/assets/js/63.410bfe1e.js"><link rel="prefetch" href="/assets/js/64.960d5951.js"><link rel="prefetch" href="/assets/js/65.e6a8895b.js"><link rel="prefetch" href="/assets/js/66.41092e16.js"><link rel="prefetch" href="/assets/js/67.062b95dc.js"><link rel="prefetch" href="/assets/js/68.58c65f95.js"><link rel="prefetch" href="/assets/js/69.d1e1b68b.js"><link rel="prefetch" href="/assets/js/7.85fc951e.js"><link rel="prefetch" href="/assets/js/70.8294a611.js"><link rel="prefetch" href="/assets/js/71.66e44dac.js"><link rel="prefetch" href="/assets/js/72.46bd34f2.js"><link rel="prefetch" href="/assets/js/73.7eb2e800.js"><link rel="prefetch" href="/assets/js/74.8e05f264.js"><link rel="prefetch" href="/assets/js/75.21e0b9b1.js"><link rel="prefetch" href="/assets/js/76.c2c92cec.js"><link rel="prefetch" href="/assets/js/77.799df679.js"><link rel="prefetch" href="/assets/js/78.1605b33c.js"><link rel="prefetch" href="/assets/js/79.659e7e78.js"><link rel="prefetch" href="/assets/js/80.6f99ca65.js"><link rel="prefetch" href="/assets/js/81.7a0caba9.js"><link rel="prefetch" href="/assets/js/82.19629840.js"><link rel="prefetch" href="/assets/js/83.29093f51.js"><link rel="prefetch" href="/assets/js/84.64568258.js"><link rel="prefetch" href="/assets/js/85.3d88e3b2.js"><link rel="prefetch" href="/assets/js/86.0a93f933.js"><link rel="prefetch" href="/assets/js/87.07c51a25.js"><link rel="prefetch" href="/assets/js/88.aa6be8e5.js"><link rel="prefetch" href="/assets/js/89.6ad93f1f.js"><link rel="prefetch" href="/assets/js/90.87c8c6e5.js"><link rel="prefetch" href="/assets/js/91.57c509b5.js"><link rel="prefetch" href="/assets/js/92.c8b02e25.js"><link rel="prefetch" href="/assets/js/93.fee86c6c.js"><link rel="prefetch" href="/assets/js/94.ab3bad19.js"><link rel="prefetch" href="/assets/js/95.cfaa79dc.js"><link rel="prefetch" href="/assets/js/96.c63afef5.js"><link rel="prefetch" href="/assets/js/97.123374a6.js"><link rel="prefetch" href="/assets/js/98.53cfb154.js"><link rel="prefetch" href="/assets/js/99.8fe1f067.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0503e0f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p>Javascript第八篇，NodeJs第二篇，注重Node后端开发。</p> <h2 id="npm"><a href="#npm" class="header-anchor">#</a> npm</h2> <p><code>npm</code> 是 Node.js 标准的软件包管理器。</p> <p>在 2017 年 1 月时，npm 仓库中就已有超过 350000 个软件包，这使其成为世界上最大的单一语言代码仓库，并且可以确定几乎有可用于一切的软件包。</p> <p>它起初是作为下载和管理 Node.js 包依赖的方式，但其现在也已成为前端 JavaScript 中使用的工具。</p> <p><code>npm</code> 可以管理项目依赖的下载。</p> <p>如果项目具有 <code>package.json</code> 文件，则通过运行npm install 安装</p> <p>它会在 <code>node_modules</code> 文件夹（如果尚不存在则会创建）中安装项目所需的所有东西。</p> <p>也可以通过运行以下命令安装特定的软件包</p> <p>npm install package-name</p> <p>通常会在此命令中看到更多标志：</p> <ul><li><code>--save</code> 安装并添加条目到 <code>package.json</code> 文件的 dependencies。</li> <li><code>--save-dev</code> 安装并添加条目到 <code>package.json</code> 文件的 devDependencies。</li></ul> <p>区别主要是，<code>devDependencies</code> 通常是开发的工具（例如测试的库），而 <code>dependencies</code> 则是与生产环境中的应用程序相关</p> <p>更新软件包与安装类似，只是命令不同</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> update
</code></pre></div><p>package.json 文件支持一种用于指定命令行任务（可通过使用以下方式运行）的格式</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> run <span class="token operator">&lt;</span>task-name<span class="token operator">&gt;</span>
</code></pre></div><p>例如</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;scripts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;start-dev&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;node lib/server-development&quot;</span>,
    <span class="token string">&quot;start&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;node lib/server-production&quot;</span>
  <span class="token punctuation">}</span>,
<span class="token punctuation">}</span>

<span class="token punctuation">{</span>
  <span class="token string">&quot;scripts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;watch&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;webpack --watch --progress --colors --config webpack.conf.js&quot;</span>,
    <span class="token string">&quot;dev&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;webpack --progress --colors --config webpack.conf.js&quot;</span>,
    <span class="token string">&quot;prod&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;NODE_ENV=production webpack -p --config webpack.conf.js&quot;</span>,
  <span class="token punctuation">}</span>,
<span class="token punctuation">}</span>
</code></pre></div><h3 id="npx"><a href="#npx" class="header-anchor">#</a> npx</h3> <p><code>npx</code> 可以运行使用 Node.js 构建并通过 npm 仓库发布的代码</p> <p><code>npx</code> 是一个非常强大的命令，从 <strong>npm</strong> 的 5.2 版本（发布于 2017 年 7 月）开始可用</p> <p><code>npx</code> 的另一个重要的特性是，无需先安装命令即可运行命令</p> <p>这非常有用，主要是因为：</p> <ol><li>不需要安装任何东西。</li> <li>可以使用 @version 语法运行同一命令的不同版本。</li></ol> <p>npx的典型应用场景有</p> <ul><li>运行 <code>vue</code> CLI 工具以创建新的应用程序并运行它们：<code>npx @vue/cli create my-vue-app</code>。</li> <li>使用 <code>create-react-app</code> 创建新的 <code>React</code> 应用：<code>npx create-react-app my-react-app</code>。</li></ul> <p>当被下载完，则下载的代码会被擦除。</p> <h3 id="npm命令集"><a href="#npm命令集" class="header-anchor">#</a> npm命令集</h3> <p>本地npm包相关</p> <p>npm outdated 检查本地npm包是否有过期包</p> <p>npm ci: 使用package-lock.json安装本地依赖</p> <p>npm rebuild: 必须使用新的二进制文件重新编译所有 C++ 插件</p> <p>npm docs:</p> <p>npm包发布相关</p> <p>npm star/unstar <package-name> : 为一个包加星标（&quot;Starring&quot;）意味着你对这个包感兴趣。 这是一种你表达关注的方式。减星标（&quot;Unstarring&quot;）与加星标相反</package-name></p> <p>npm team:</p> <p>npm publish：</p> <p>npm deprecate: 此命令将更新 npm 注册表中指定包所对应的数据条目， 为尝试安装它的所有人提示版本作废的警告信息</p> <p>其他</p> <p>npm ping： Ping 已配置的或给定的 npm 注册表地址并进行身份验证。 如果 ping 执行成功，则会输出类似下面的内容</p> <p>npm config：</p> <p>npm repo: 此命令尝试猜测指定包的源码仓库的 URL ，然后再使用 <code>--browser</code> 配置参数打开它。 如果没有提供包名称，它将在当前文件夹中搜索<code>package.json</code> 文件， 并使用其 <code>name</code> 属性的值</p> <h3 id="pnpm、yarn、cnpm、npm的区别"><a href="#pnpm、yarn、cnpm、npm的区别" class="header-anchor">#</a> pnpm、yarn、cnpm、npm的区别</h3> <p>pnpm 本质上就是一个包管理器，这一点跟 npm/yarn 没有区别，但它作为杀手锏的两个优势在于:</p> <ul><li>包安装速度极快；</li> <li>磁盘空间利用非常高效</li></ul> <p><strong>速度</strong></p> <p>pnpm，在绝多大数场景下，包安装的速度都是明显优于 npm/yarn，速度会比 npm/yarn 快 2-3 倍</p> <p>yarn 有 <code>PnP 安装模式</code>(https://classic.yarnpkg.com/en/docs/pnp/)吗？直接去掉 node_modules，将依赖包内容写在磁盘，节省了 node 文件 I/O 的开销，这样也能提升安装速度</p> <p><strong>支持mono repo</strong></p> <p>随着前端工程的日益复杂，越来越多的项目开始使用 monorepo。之前对于多个项目的管理，我们一般都是使用多个 git 仓库，但 monorepo 的宗旨就是用一个 git 仓库来管理多个子项目，所有的子项目都存放在根目录的<code>packages</code>目录下，那么一个子项目就代表一个<code>package</code>。如果你之前没接触过 monorepo 的概念，建议仔细看看这篇文章(https://www.perforce.com/blog/vcs/what-monorepo)以及开源的 monorepo 管理工具<code>lerna</code>，项目目录结构可以参考一下 <code>babel 仓库</code>(https://github.com/babel/babel)。</p> <p>pnpm 与 npm/yarn 另外一个很大的不同就是支持了 monorepo，体现在各个子命令的功能上，比如在根目录下 <code>pnpm add A -r</code>, 那么所有的 package 中都会被添加 A 这个依赖，当然也支持 <code>--filter</code>字段来对 package 进行过滤</p> <p><strong>高效利用磁盘空间</strong></p> <p>pnpm 内部使用<code>基于内容寻址</code>的文件系统来存储磁盘上所有的文件，这个文件系统出色的地方在于</p> <p>不会重复安装同一个包。用 npm/yarn 的时候，如果 100 个项目都依赖 lodash，那么 lodash 很可能就被安装了 100 次，磁盘中就有 100 个地方写入了这部分代码。但在使用 pnpm 只会安装一次，磁盘中只有一个地方写入，后面再次使用都会直接使用 <code>hardlink</code></p> <p>即使一个包的不同版本，pnpm 也会极大程度地复用之前版本的代码。举个例子，比如 lodash 有 100 个文件，更新版本之后多了一个文件，那么磁盘当中并不会重新写入 101 个文件，而是保留原来的 100 个文件的 <code>hardlink</code>，仅仅写入那<code>一个新增的文件</code></p> <p><strong>依赖管理</strong></p> <p>npm install 的原理：</p> <p>主要分为两个部分, 首先，执行 npm/yarn install之后，<code>包如何到达项目 node_modules 当中</code>。其次，node_modules <code>内部如何管理依赖</code>。</p> <p>执行命令后，首先会构建依赖树，然后针对每个节点下的包，会经历下面四个步骤:</p> <p>- 1. 将依赖包的版本区间解析为某个具体的版本号
- 2. 下载对应版本依赖的 tar 包到本地离线镜像
- 3. 将依赖从离线镜像解压到本地缓存
- 4. 将依赖从缓存拷贝到当前目录的 node_modules 目录</p> <p>然后，对应的包就会到达项目的<code>node_modules</code>当中。</p> <p>在 <code>npm1</code>、<code>npm2</code> 中呈现出的是嵌套结构，如果不同的依赖包有着相同包的不同版本，会出现以下问题：</p> <ul><li>依赖层级太深，会导致文件路径过长的问题，尤其在 window 系统下。</li> <li>大量重复的包被安装，文件体积超级大。比如跟 foo 同级目录下有一个baz，两者都依赖于同一个版本的lodash，那么 lodash 会分别在两者的 node_modules 中被安装，也就是重复安装。</li> <li>模块实例不能共享。比如 React 有一些内部变量，在两个不同包引入的 React 不是同一个模块实例，因此无法共享内部变量，导致一些不可预知的 bug。安全性**</li></ul> <p>从npm3开始，以及yarn中，都着手来通过<code>扁平化依赖</code>的方式来解决这个问题</p> <p>所有的依赖都被拍平到<code>node_modules</code>目录下，不再有很深层次的嵌套关系。这样在安装新的包时，根据 node require 机制，会不停往上级的<code>node_modules</code>当中去找，如果找到相同版本的包就不会重新安装，解决了大量包重复安装的问题，而且依赖层级也不会太深。</p> <p>但是铺平的node_modules依然有很多问题：</p> <ol><li>依赖结构的<strong>不确定性</strong>。</li> <li>扁平化算法本身的<strong>复杂性</strong>很高，耗时较长。</li> <li>项目中仍然可以<strong>非法访问</strong>没有声明过依赖的包</li></ol> <p>第一个问题直接导致了 <code>lock 文件</code>的诞生，无论是<code>package-lock.json</code>(npm 5.x才出现)还是<code>yarn.lock</code>，都是为了保证 install 之后都产生确定的<code>node_modules</code>结构</p> <p>不同于npm/yarn，使用pnpm安装包后，会在node_modules下会生成包的软连接，有助于快速找到安装了哪些包</p> <p>同时，所有的包都放在.pnpm文件夹下，按照<package-name> @version/node_modules <package-name>的嵌套结构在.pnpm下。再看看<code>.pnpm</code>，<code>.pnpm</code>目录下虽然呈现的是扁平的目录结构，但仔细想想，顺着<code>软链接</code>慢慢展开，其实就是嵌套的结构。这样将<code>包本身</code>和<code>依赖</code>放在同一个<code>node_module</code>下面，与原生 Node 完全兼容，又能将 package 与相关的依赖很好地组织到一起，设计十分精妙</package-name></package-name></p> <p><strong>非法访问的问题</strong></p> <p>在npm/yarn中，如果 A 依赖 B， B 依赖 C，那么 A 就算没有声明 C 的依赖，由于有依赖提升的存在，C 被装到了 A 的<code>node_modules</code>里面，那我在 A 里面是可以用 C的，并且跑起来也没有问题。</p> <p>但是当包依赖变化时， 如果 B 更新之后，可能不需要 C 了，那么安装依赖的时候，C 都不会装到<code>node_modules</code>里面，A 当中引用 C 的代码直接报错。还有一种情况，在 monorepo 项目中，如果 A 依赖 X，B 依赖 X，还有一个 C，它不依赖 X，但它代码里面用到了 X。由于依赖提升的存在，npm/yarn 会把 X 放到根目录的 node_modules 中，这样 C 在本地是能够跑起来的，因为根据 node 的包加载机制，它能够加载到 monorepo 项目根目录下的 node_modules 中的 X。但试想一下，一旦 C 单独发包出去，用户单独安装 C，那么就找不到 X 了，执行到引用 X 的代码时就直接报错了。</p> <p>这些，都是依赖提升潜在的 bug。如果是自己的业务代码还好，试想一下如果是给很多开发者用的工具包，那危害就非常严重了。</p> <p>npm 也有想过去解决这个问题，指定<code>--global-style</code>参数即可禁止变量提升，但这样做相当于回到了当年嵌套依赖的时代，一夜回到解放前，前面提到的嵌套依赖的缺点仍然暴露无遗。</p> <p>npm/yarn 本身去解决依赖提升的问题貌似很难完成，不过社区针对这个问题也已经有特定的解决方案: <strong>dependency-check</strong>，地址: https://github.com/dependency-check-team/dependency-check</p> <p>pnpm 做的更加彻底，独创的一套依赖管理方式不仅解决了依赖提升的安全问题，还大大优化了时间和空间上的性能。</p> <h3 id="npm私库的搭建"><a href="#npm私库的搭建" class="header-anchor">#</a> npm私库的搭建</h3> <p>npm 作为一种包管理工具，无论你是泛前端还是大前端都已经离不开它。它的出现方便了万千少年。让我们跨过了 Ctrl+C、Ctrl+V ，通过 <code>npm install x</code>的方式将别人的优秀代码模块引入到自己的项目中。这些优秀的模块能被共享的原因，一方面是有 npm 这么一个包管理工具，另外就是 npm 仓库。</p> <p>对于 npm 仓库，如果你还停留在使用 npm 或者 cnpm 这类官方源的情况下。那么你有必要想想如何搭建一个私有的 npm 仓库。</p> <p>搭建npm私库的原因：</p> <p>1.稳定性</p> <p>网络访问稳定性，私有仓库因为是自己公司在维护，有什么问题能第一时间处理，比如服务宕机…其次资源的稳定性，试想一下，如果哪天你依赖的某个很重要的模块突然被作者删了，那是不是完犊子了</p> <p>2.私密性</p> <p>每个公司都有和自己业务强相关的模块，或者对某些开源模块进行个性化的改造，改造后的模块只满足本公司的业务场景，这些模块我们并不希望发布到公共的仓库中去，这时就可以发布到自己的私有仓库在公司内部共享</p> <p>3.安全性</p> <p>有了私有仓库后，可以在 npm 模块的质量和安全上做文章，能够有效的防治恶意代码攻击。</p> <p>搭建</p> <p>选择<a href="https://www.npmjs.com/package/cnpmjs.org" target="_blank" rel="noopener noreferrer">cnpmjs.org<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方案，目前国内像淘宝这样的大厂内部也是选择的它，足以证明它的可靠性和稳定性，拓展性强，配置多样化</p> <p>环境</p> <ul><li>Linux 服务器</li> <li>node 环境</li> <li>数据库( Mysql )</li> <li>nginx</li></ul> <p>安装</p> <p>首先安装cnpmjs.org</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/cnpm/cnpmjs.org.git
</code></pre></div><p>安装项目依赖</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i
</code></pre></div><p>安装完成后找到项目根目录下的配置文件<code>config/index.js</code> ，这里配置文件非常多，刚开始可以只关注下面几项即可，<a href="https://gitee.com/199253/cnpmjs/blob/master/config/index.js" target="_blank" rel="noopener noreferrer">详细配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>戳这里。</p> <p>服务访问端口</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">registryPort</span><span class="token punctuation">:</span> <span class="token number">7001</span><span class="token punctuation">,</span>         //仓库服务访问端口
<span class="token key atrule">webPort</span><span class="token punctuation">:</span> <span class="token number">7002</span><span class="token punctuation">,</span>              //web站点访问端口
<span class="token key atrule">bindingHost</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>   //监听绑定的 Host，默认127.0.0.1，外网访问注释掉此项即可，一般我们不会把我们内部端口暴露出去，可以在nginx层做一个转发，所以这个配置可以注释掉。如果直接外网访问，配置为 0.0.0.0
</code></pre></div><p>数据库配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span> <span class="token string">'npm'</span><span class="token punctuation">,</span>数据库名称
  <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>//用户
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">'admin123'</span><span class="token punctuation">,</span>//密码
  // 数据库类型
  // <span class="token punctuation">-</span> 目前支持 'mysql'<span class="token punctuation">,</span> <span class="token string">'sqlite'</span><span class="token punctuation">,</span> <span class="token string">'postgres'</span><span class="token punctuation">,</span> <span class="token string">'mariadb'</span>
  <span class="token key atrule">dialect</span><span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>//默认是sqlite，我选择的mysql
  <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> //数据库服务地址
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>    // 端口
  // 数据库连接池使用默认配置就好
  // 目前只支持  mysql 和 postgresql (since v1.5.0)
  <span class="token key atrule">pool</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token key atrule">minConnections</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token key atrule">maxIdleTime</span><span class="token punctuation">:</span> <span class="token number">30000</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">...</span>//其他的暂时不用关注
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>是否启用私有模式</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">enablePrivate</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span>//默认不启用
</code></pre></div><p>私有模式下，只有管理员才能发布模块。非管理员发布模块式命名必须以 scopes 字段开头例如：<code>@catfly/packagename</code></p> <p>发布前缀</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">scopes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@catfly'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>这个和启用非私有模式配套使用，非私有模式要发布必须配置该项。</p> <p>管理员配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">admins</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token key atrule">fengmk2</span><span class="token punctuation">:</span> <span class="token string">'fengmk2@gmail.com'</span><span class="token punctuation">,</span>
      <span class="token key atrule">admin</span><span class="token punctuation">:</span> <span class="token string">'admin@cnpmjs.org'</span><span class="token punctuation">,</span>
      <span class="token key atrule">dead_horse</span><span class="token punctuation">:</span> <span class="token string">'dead_horse@qq.com'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果启用私有模式，只有该配置项中的用户可以发布私有包。至于其他的配置项暂时不用关注，后面根据需要在逐渐配置起来。</p> <p>同步模式</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>// 同步模式选项
<span class="token key atrule">// none</span><span class="token punctuation">:</span> 不进行同步，只管理用户上传的私有模块，公共模块直接从上游获取
<span class="token key atrule">// exist</span><span class="token punctuation">:</span> 只同步已经存在于数据库的模块
<span class="token key atrule">// all</span><span class="token punctuation">:</span> 定时同步所有源registry的模块
syncModel<span class="token punctuation">:</span><span class="token string">'exist'</span>
</code></pre></div><p>数据库</p> <p>我选择的 mysql ，请<a href="https://www.runoob.com/mysql/mysql-install.html" target="_blank" rel="noopener noreferrer">戳这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。当然你也可以选择其他数据库，目前支持mysql 、 sqlite 、 postgres 、 mariadb ，默认是 sqlite 。</p> <p>确认数据库启动</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">service</span> mysql status
</code></pre></div><p>登陆数据库</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span>  test123456
</code></pre></div><p>创建数据库</p> <div class="language-shell extra-class"><pre class="language-shell"><code>create database <span class="token function">npm</span>
</code></pre></div><p>查看数据库列表</p> <div class="language-shell extra-class"><pre class="language-shell"><code>show database
</code></pre></div><p>执行sql文件</p> <p>cnpmjs.org项目docs目录下已经给我们备好了创建数据库的脚本db.sql.执行</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">source</span> docs/db.sql
</code></pre></div><p>然后使用数据库</p> <div class="language-shell extra-class"><pre class="language-shell"><code>use <span class="token function">npm</span> 
show tables
</code></pre></div><p>上面两步完成后，就可以将项目跑起来一睹芳容了。因为我们通过 git 克隆的，所以需要进入到项目目录下执行启动服务的命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> run start
</code></pre></div><p>如果服务器的7002端口访问不了，可能是防火墙的原因，可以关闭防火墙或者开放指定端口</p> <div class="language-shell extra-class"><pre class="language-shell"><code>iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--drop</span> <span class="token parameter variable">-j</span> <span class="token number">7002</span> DROP
</code></pre></div><p>访问 web 页面：xxx.xxx.xxx.xx:7002，就可以看见熟悉的部署在本地的 cnpm 页面了</p> <p>如果配置域名访问则需要使用nginx代理，这里简单贴一下nginx.conf配置</p> <div class="language-conf extra-class"><pre class="language-text"><code>server{
      listen  80;
       server_name www.mirrors.catfly.vip;
       #charset koi8-r;
       #access_log  logs/host.access.log  main;
       location / { 
            proxy_pass http://127.0.0.1:7002/; #代理到cnpmjs.org提供的web服务
            proxy_set_header        X-Real-IP $remote_addr;
       }
       location /registry/ {
           proxy_pass http://127.0.0.1:7001/; # 代理到cnpmjs.org提供的注册服务
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header Host $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       }
       #error_page  404              /404.html;
       # redirect server error pages to the static page /50x.html
       # error_page   500 502 503 504  /50x.html;
       location = /50x.html {
           root   html;
       }
}
</code></pre></div><p>验证</p> <p>在本地安装一个nrm工具，使用比较方便</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i nrm <span class="token parameter variable">-g</span>
</code></pre></div><p>安装成功后新增我们自己的私有源到nrm源列表中。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>nrm <span class="token function">add</span> catfly http://www.mirrors.catfly.vip/registry
</code></pre></div><p>切换到私有源</p> <div class="language-shell extra-class"><pre class="language-shell"><code>nrm use catfly
</code></pre></div><p>这个时候本地执行 npm 操作的时候就会去找到我们自己的私有地址</p> <h4 id="进程管理"><a href="#进程管理" class="header-anchor">#</a> 进程管理</h4> <p>推荐使用 pm2 进行进程管理，虽然项目本身提供了<code>npm run start</code>和<code>npm run stop</code>的能力，但是这对于一个企业级的应用来说还是太弱了，使用 pm2 的好处如下：</p> <ol><li>随时随地多进程管理</li> <li>完善的监控机制，我们可以清晰地看见整个集群的模式、状态，CPU 利用率甚至是内存大小</li> <li>负责均衡</li> <li>进程守护</li> <li>...</li></ol> <p>全局安装pm2</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i pm2 <span class="token parameter variable">-g</span>
</code></pre></div><p>启动项目</p> <div class="language-shell extra-class"><pre class="language-shell"><code>pm2 start ./dispatch.js
</code></pre></div><p>查看服务进程信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code>pm2 monit dispatch
</code></pre></div><h4 id="私有库上云"><a href="#私有库上云" class="header-anchor">#</a> 私有库上云</h4> <p>cnpmjs.org 项目配置项里面有一个 <code>nfs</code>配置，这里定义了一个 npm 文件系统（NFS）。私有仓库在同步和上传的时候，会交给 NFS 对象相应的函数去处理，NFS 对象返回处理结束之后再返回下载链接，所以通过自定义 NFS 模块可以实现 npm 包的各种定制存储。目前官方默认使用<code>fs-cnpm</code>，该模块会将上传或者同步的包保存在服务器本地的<code>/root/.cnpmjs.org/doenloads/</code>目录下。这种方式比较传统，一方面随着私有包数量的不断增加，存储资源会是一个瓶颈。</p> <p>这个时候将私有包或者同步的资源放到云上就是一个非常好的方案。cnpmjs.org 官方早就为我们想到了这点，给出了下面几种 NFS 模块：</p> <ul><li><a href="https://link.jianshu.com/?t=https://github.com/cnpm/upyun-cnpm" target="_blank" rel="noopener noreferrer">upyun-cnpm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：又拍云存储插件</li> <li><a href="https://link.jianshu.com/?t=https://github.com/cnpm/fs-cnpm" target="_blank" rel="noopener noreferrer">fs-cnpm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：本地存储的插件</li> <li><a href="https://link.jianshu.com/?t=https://github.com/cnpm/sfs-client" target="_blank" rel="noopener noreferrer">sfs-client<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>： <a href="https://link.jianshu.com/?t=https://github.com/cnpm/sfs" target="_blank" rel="noopener noreferrer">SFS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（Simple FIle Store）存储插件</li> <li><a href="https://link.jianshu.com/?t=https://github.com/cnpm/qn-cnpm" target="_blank" rel="noopener noreferrer">qn-cnpm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：七牛云存储插件</li> <li><a href="https://link.jianshu.com/?t=https://github.com/cnpm/oss-cnpm" target="_blank" rel="noopener noreferrer">oss-cnpm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：阿里云 OSS 存储插件</li></ul> <p>这些模块已经能够满足我们绝大部分的场景，如果你有特殊的需求，可以参看<a href="https://www.v2ex.com/t/294255" target="_blank" rel="noopener noreferrer">nfs模块规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>进行定制化开发。这里拿阿里云 oss 存储作为示例。</p> <p>首先在 cnpmjs.org 项目目录下安装<code>oss-cnpm</code>模块</p> <div class="language-shell extra-class"><pre class="language-shell"><code>cnpm i oss-cnpm
</code></pre></div><p>然后在云服务控制台 oss 管理中新增了一个 bucket 来存储 npm 包，也可以通过上传路径区分来复用其他 bucket，毕竟在公司中 bucket 资源一般还是比较紧张的。然后修改项目配置文件，将默认的<code>fs-cnpm</code>模块替换成<code>oss-cnpm</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> oss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;oss-cnpm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nfs <span class="token operator">=</span> oss<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">accessKeyId</span><span class="token operator">:</span> <span class="token string">'xxxx'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">accessKeySecret</span><span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">endpoint</span><span class="token operator">:</span> <span class="token string">'oss-cn-beijing.aliyuncs.com'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">bucket</span><span class="token operator">:</span> <span class="token string">'catfly-xxx'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'private'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token punctuation">,</span>
  <span class="token literal-property property">nfs</span><span class="token operator">:</span>nfs<span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重启项目，这个时候再发布或者同步资源的时候，服务器本地目录不会有新发布或同步的包了，在 oss 对应的 bucket 里面能找到刚刚发布或者同步的资源。</p> <h2 id="node运行原理"><a href="#node运行原理" class="header-anchor">#</a> Node运行原理</h2> <h3 id="运行原理"><a href="#运行原理" class="header-anchor">#</a> 运行原理</h3> <p>Node.js 被分为了四层，分别是 <code>应用层</code>、<code>V8引擎层</code>、<code>Node API层</code> 和 <code>LIBUV层</code>。</p> <p>应用层： 即 JavaScript 交互层，常见的就是 Node.js 的模块，比如 http，fs</p> <p>V8引擎层： 即利用 V8 引擎来解析JavaScript 语法，进而和下层 API 交互</p> <p>NodeAPI层： 为上层模块提供系统调用，一般是由 C 语言来实现，和操作系统进行交互 。</p> <p>LIBUV层： 是跨平台的底层封装，实现了 事件循环、文件操作等，是 Node.js 实现异步的核心</p> <h3 id="事件循环"><a href="#事件循环" class="header-anchor">#</a> 事件循环</h3> <p>node事件循环与浏览器循环是不同的</p> <p>当Node.js启动时会初始化<code>event loop</code>, 每一个<code>event loop</code>都会包含按如下顺序六个循环阶段：</p> <p>1.<strong><code>timers</code> 阶段</strong>: 这个阶段执行 <code>setTimeout(callback)</code> 和 <code>setInterval(callback)</code> 预定的 callback, timer指定一个下限时间而不是准确时间，在达到这个下限时间后执行回调。在指定时间过后，timers会尽可能早地执行回调，但系统调度或者其它回调的执行可能会延迟它们。</p> <p>2.<strong><code>I/O callbacks</code> 阶段</strong>: 此阶段执行某些系统操作的回调，例如TCP错误的类型。 例如，如果TCP套接字在尝试连接时收到 ECONNREFUSED，则某些* nix系统希望等待报告错误。 这将操作将等待在==I/O回调阶段==执行;</p> <p>3.<strong><code>idle, prepare</code> 阶段</strong>: 仅node内部使用;</p> <p>4.<strong><code>poll</code> 阶段</strong>:</p> <p>获取新的I/O事件, 例如操作读取文件等等，适当的条件下node将阻塞在这里;</p> <p>如果 poll 队列不空，event loop会遍历队列并同步执行回调，直到队列清空或执行的回调数到达系统上限；</p> <p>如果 poll 队列为空，则发生以下两件事之一：</p> <p>如果代码已经被setImmediate()设定了回调, event loop将结束 poll 阶段进入 check 阶段来执行 check 队列（里面的回调 callback）。</p> <p>如果代码没有被setImmediate()设定回调，event loop将阻塞在该阶段等待回调被加入 poll 队列，并立即执行。setImmediate() 实际上是一个特殊的timer，跑在event loop中一个独立的阶段。它使用<code>libuv</code>的API 来设定在 poll 阶段结束后立即执行回调。</p> <p>5.<strong><code>check</code> 阶段</strong>: 执行 <code>setImmediate()</code> 设定的callbacks，check阶段在poll阶段之后;</p> <p>6.<strong><code>close callbacks</code> 阶段</strong>: 比如 <code>socket.on(‘close’, callback)</code> 的callback会在这个阶段执行;如果一个 socket 或 handle 被突然关掉，close事件将在这个阶段被触发，否则将通过process.nextTick()触发</p> <p>日常开发的绝大部分异步任务都在timers、poll、check这3个阶段处理的</p> <h3 id="node事件循环与浏览器事件循环的区别"><a href="#node事件循环与浏览器事件循环的区别" class="header-anchor">#</a> Node事件循环与浏览器事件循环的区别</h3> <p>在浏览器环境中，microtask任务队列是每个macrotask执行完之后执行，而在Nodejs中microtask在事件循环的各个阶段之间执行</p> <h3 id="setimmediate与settimeout与next-tick"><a href="#setimmediate与settimeout与next-tick" class="header-anchor">#</a> setimmediate与settimeout与next tick</h3> <p>两者非常相似，区别在于调用时机不同：</p> <p>setimmediate设计在poll阶段完成时执行，即check阶段；</p> <p>setTimeout设计在poll阶段为空闲时，且设定事件达到后执行，但它在timer阶段执行</p> <p>但当二者在异步i/o callback内部调用时，总是先执行setimmediate，再执行setTimeout</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//setTimeout可能先执行也可能后执行</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>_filename<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//setImmediate总是先于setTimeout</span>
</code></pre></div><h3 id="process-nexttick"><a href="#process-nexttick" class="header-anchor">#</a> process.nextTick</h3> <p>这个函数是独立于Event Loop之外的，有自己的队列，当每个阶段完成时，如果存在nextTick队列就清空队列中的所有回调函数，并且优先于其他microtask执行</p> <h2 id="常用方法"><a href="#常用方法" class="header-anchor">#</a> 常用方法</h2> <h3 id="sleep函数"><a href="#sleep函数" class="header-anchor">#</a> sleep函数</h3> <p>阻塞主线程，</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  expire <span class="token operator">=</span> start <span class="token operator">+</span> ms<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> expire<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="功能模块"><a href="#功能模块" class="header-anchor">#</a> 功能模块</h2> <h3 id="commander-js"><a href="#commander-js" class="header-anchor">#</a> commander.js</h3> <p>前端开发node cli 必备技能。</p> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> commander
</code></pre></div><p>api</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> program <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
program
    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;intl helper&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">'0.0.1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token comment">//执行结果：</span>
node index<span class="token punctuation">.</span>js <span class="token operator">-</span><span class="token constant">V</span>
 
<span class="token number">0.0</span><span class="token number">.1</span>
<span class="token comment">//如果希望程序响应-v选项而不是-V选项，</span>
<span class="token comment">//只需使用与option方法相同的语法将自定义标志传递给version方法</span>
program
  <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">'0.0.1'</span><span class="token punctuation">,</span> <span class="token string">'-v, --version'</span><span class="token punctuation">)</span>
</code></pre></div><p>commander.js中命令行有两种可变性，一个叫做<code>option</code>，意为选项。一个叫做<code>command</code>，意为命令。</p> <p>常用api</p> <p><code>version</code></p> <p>用法： <code>.version('x.y.z')</code></p> <p>用于设置命令程序的版本号，</p> <p><code>option</code></p> <p>用户：<code>.option('-n, --name &lt;name&gt;', 'your name', 'GK')</code></p> <ul><li>第一个参数是选项定义，分为短定义和长定义。用|，,， 连接。
<ul><li>参数可以用<code>&lt;&gt;</code>或者<code>[]</code>修饰，前者意为必须参数，后者意为可选参数。</li></ul></li> <li>第二个参数为选项描述</li> <li>第三个参数为选项参数默认值，可选。</li></ul> <p><code>command</code></p> <p>用法：<code>.command('init &lt;path&gt;', 'description')</code></p> <ul><li><code>command</code>的用法稍微复杂，原则上他可以接受三个参数，第一个为命令定义，第二个命令描述，第三个为命令辅助修饰对象。</li> <li>第一个参数中可以使用<code>&lt;&gt;</code>或者<code>[]</code>修饰命令参数</li> <li>第二个参数可选。
<ul><li>当没有第二个参数时，commander.js将返回<code>Command</code>对象，若有第二个参数，将返回原型对象。</li> <li>当带有第二个参数，并且没有显示调用<code>action(fn)</code>时，则将会使用子命令模式。</li> <li>所谓子命令模式即，<code>./pm</code>，<code>./pm-install</code>，<code>./pm-search</code>等。这些子命令跟主命令在不同的文件中。</li></ul></li> <li>第三个参数一般不用，它可以设置是否显示的使用子命令模式。</li></ul> <p><code>description</code></p> <p>用法：<code>.description('command description')</code></p> <p>用于设置命令的描述</p> <p>用法：<code>.action(fn)</code></p> <p>用于设置命令执行的相关回调。<code>fn</code>可以接受命令的参数为函数形参，顺序与<code>command()</code>中定义的顺序一致。</p> <p><code>parse</code></p> <p>用法：<code>program.parse(process.argv)</code></p> <p>此api一般是最后调用，用于解析<code>process.argv</code>。</p> <p><code>outputHelp</code></p> <p>用法：<code>program.outputHelp()</code></p> <p>一般用于未录入参数时自动打印帮助信息。</p> <h3 id="inquire"><a href="#inquire" class="header-anchor">#</a> inquire</h3> <p><code>Inquirer.js</code>可以理解成就是给输入命令行的用户提供一个好看的界面，提供一下功能：</p> <ul><li>有错误反馈；</li> <li>向用户提问；</li> <li>解析输入；</li> <li>校验回答；</li> <li>能在用户输入的时候提供友好的提示。</li></ul> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> <span class="token function">add</span> inquirer --save-dev
</code></pre></div><p>Inquirer 提供<code>prompt</code>对象，该对象中提供配置项，<code>then</code>会在用户回答完所有问题后执行，<code>catch</code>则是报出异常：</p> <p>prompt是一个对象数组，对象主要包含以下几种配置：</p> <p>type： 类型，主要类型有input、number、confirm、list、rawlist、expand、checkbox、password、editor；</p> <p>name：可以理解成当前回答的变量名；</p> <p>message：问题描述；</p> <p>default：问题的默认值；</p> <p>choice：问题选项；</p> <p>validate：回答的校验器；</p> <p>filter：回答的过滤器；</p> <p>transformer：接收用户输入，回答散列和选项标志，并返回一个转换后的值显示给用户。</p> <p>when：是否应该问这个问题</p> <p>PageSize：控制选项显示的个数，就是是否当前最多显示多少个选项，如果超过则需要向下才能显示更多；</p> <p>prefix：更改默认的前缀消息。</p> <p>suffix：更改默认后缀消息。</p> <p>askAnswered：如果答案已经存在，就必须提出问题。</p> <p>loop：是否启用列表循环。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> inquirer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'inquirer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'preset'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Please pick a preset:'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">choices</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'default(babel, eslint)'</span><span class="token punctuation">,</span> <span class="token string">'Manually select feature'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">filter</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> val<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'key'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;input the text key:&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'checkbox'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'features'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Checkout the feature needed for you project:'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">choices</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Babel'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'TypeScript'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Progressive Web App (PWA) Support'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Router'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Vuex'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'CSS Pre-processors'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Linter / Formatter'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Unit Testing'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'E2E Testing'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pageSize</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token function-variable function">validate</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">answer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>answer<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">'You must choose at least one topping.'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">answers</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>answers<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'  '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="chalk"><a href="#chalk" class="header-anchor">#</a> chalk</h3> <p><code>chalk</code> 包的作用是修改控制台中字符串的样式，包括：</p> <ol><li>字体样式(加粗、隐藏等)</li> <li>字体颜色</li> <li>背景颜色</li></ol> <p>使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span>red<span class="token punctuation">.</span>bold<span class="token punctuation">.</span><span class="token function">bgWhite</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="process"><a href="#process" class="header-anchor">#</a> process</h3> <p><a href="https://www.npmjs.com/package/progress" target="_blank" rel="noopener noreferrer">progress <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是现在最常用的 <code>npm</code> 包用来渲染进度条。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">--save</span> progress
</code></pre></div><p>使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'progress'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">':bar'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\ncomplete\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="http-proxy-middleware包"><a href="#http-proxy-middleware包" class="header-anchor">#</a> http-proxy-middleware包</h3> <p>http-proxy-middleware用于把请求转发到其他服务器的中间件</p> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev http-proxy-middleware
</code></pre></div><p>使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createProxyMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'http-proxy-middleware'</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
	<span class="token string">'/api-metrics/*'</span><span class="token punctuation">,</span>
  <span class="token function">createProxyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'192.168.8.8:9090'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token string-property property">'api-metrics'</span><span class="token operator">:</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="history-fallback包"><a href="#history-fallback包" class="header-anchor">#</a> history fallback包</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> history <span class="token keyword">from</span> <span class="token string">'connect-history-api-fallback'</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">history</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="prisma"><a href="#prisma" class="header-anchor">#</a> prisma</h3> <p>数据库orm</p> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> prisma <span class="token parameter variable">-D</span>
</code></pre></div><p>Schema.prisma是prisma主要的配置文件，配置主要分为：</p> <p>1.DB连接的配置</p> <p>2.Prisma Client的配置</p> <p>3.data model的定义</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>datasource db <span class="token punctuation">{</span>
  provider <span class="token operator">=</span> <span class="token string">&quot;sqlite&quot;</span>
  url <span class="token operator">=</span> <span class="token string">&quot;file:dev.db&quot;</span>
<span class="token punctuation">}</span>

generator client <span class="token punctuation">{</span>
	provider <span class="token operator">=</span> <span class="token string">&quot;prisma-client-js&quot;</span>
<span class="token punctuation">}</span>

model User <span class="token punctuation">{</span>
  id     Int
  email  String
  name   String
<span class="token punctuation">}</span>
</code></pre></div><p>生成数据表</p> <div class="language-shell extra-class"><pre class="language-shell"><code>prisma generate
</code></pre></div><p>引入</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> PrismaClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@prisma/client'</span>

<span class="token keyword">const</span> prisma <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrismaClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="文件包"><a href="#文件包" class="header-anchor">#</a> 文件包</h3> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> fs-extra
</code></pre></div><p>文件包可以替代原生的node fs模块，实现更强大的文件处理功能。</p> <p>导入</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span>
</code></pre></div><p>异步拷贝文件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Async with promises:</span>
fs<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token string">'/tmp/myfile'</span><span class="token punctuation">,</span> <span class="token string">'/tmp/mynewfile'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Sync:</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">copySync</span><span class="token punctuation">(</span><span class="token string">'/tmp/myfile'</span><span class="token punctuation">,</span> <span class="token string">'/tmp/mynewfile'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="node-rsa"><a href="#node-rsa" class="header-anchor">#</a> node-rsa</h3> <p>在node中使用rsa算法</p> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> node-rsa
</code></pre></div><p>使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> NodeRSA <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node-rsa&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeRSA</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">b</span><span class="token operator">:</span><span class="token number">2048</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//2048 密钥长度</span>
ket<span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">encryptionSchema</span><span class="token operator">:</span> <span class="token string">'pkcs1'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//指定加密格式，不改格式的话可能会报错</span>


</code></pre></div><h3 id="youdao-node"><a href="#youdao-node" class="header-anchor">#</a> youdao-node</h3> <p>使用有道云api进行翻译</p> <h3 id="pino"><a href="#pino" class="header-anchor">#</a> pino</h3> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> pino
</code></pre></div><p>使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pino'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token string">'property'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'hello child!'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="转码包"><a href="#转码包" class="header-anchor">#</a> 转码包</h3> <p>node默认支持utf8、base64、binary，如果要请求或处理GBK或者Gb2312页面或文件就需要转码</p> <p>安装iconv-lite</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> iconv-lite <span class="token parameter variable">--save</span> 
</code></pre></div><p>引入</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> iconv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'iconv-lite'</span><span class="token punctuation">)</span>
</code></pre></div><p>在原来的输出语句中加入解码函数就可以</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stdout'</span><span class="token operator">+</span>iconv<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token string">'GBK'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="node-redis"><a href="#node-redis" class="header-anchor">#</a> node-redis</h3> <h3 id="graphql"><a href="#graphql" class="header-anchor">#</a> Graphql</h3> <p>安装依赖</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install apollo<span class="token operator">-</span>server@<span class="token number">2.13</span><span class="token number">.1</span> graphql@<span class="token number">14.6</span><span class="token number">.0</span>  type<span class="token operator">-</span>graphql@<span class="token number">0.17</span><span class="token number">.6</span>
</code></pre></div><p>引入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">&quot;reflect-metadata&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>buildSchema<span class="token punctuation">,</span>ObjectType<span class="token punctuation">,</span>Field<span class="token punctuation">,</span><span class="token constant">ID</span><span class="token punctuation">,</span>Resolver<span class="token punctuation">,</span>Query<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;type-graphql&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ApolloServer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;apollo-server&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>后端定义schema和resolver</p> <div class="language-js extra-class"><pre class="language-js"><code>@<span class="token function">ObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Post</span><span class="token punctuation">{</span>
    @<span class="token function">Field</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token constant">ID</span><span class="token punctuation">)</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> string<span class="token punctuation">;</span>

    @<span class="token function">Field</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token literal-property property">created</span><span class="token operator">:</span> Data<span class="token punctuation">;</span>

    @<span class="token function">Field</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> String<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">Resolver</span><span class="token punctuation">(</span>Post<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">PostResolver</span> <span class="token punctuation">{</span>
    @<span class="token function">Query</span><span class="token punctuation">(</span><span class="token parameter">returns</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>Post<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token function">posts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Post<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
           <span class="token punctuation">{</span>
              <span class="token literal-property property">id</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">created</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token literal-property property">content</span><span class="token operator">:</span><span class="token string">'aaa'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token literal-property property">id</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">created</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token literal-property property">content</span><span class="token operator">:</span><span class="token string">'bbb'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token literal-property property">id</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">created</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token literal-property property">content</span><span class="token operator">:</span><span class="token string">'ccc'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行项目，在localhost:4444打开graphql的playground进行测试</p> <h3 id="剪贴板的使用"><a href="#剪贴板的使用" class="header-anchor">#</a> 剪贴板的使用</h3> <p>使用第三方包，安装</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install clipboard<span class="token operator">-</span>polyfill
</code></pre></div><p>引用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> clipboard <span class="token keyword">from</span> <span class="token string">&quot;clipboard-polyfill&quot;</span>
</code></pre></div><p>实例</p> <div class="language-js extra-class"><pre class="language-js"><code>clipboard<span class="token punctuation">.</span><span class="token function">writeText</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
clipboard<span class="token punctuation">.</span><span class="token function">readText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span>console<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="终端二维码"><a href="#终端二维码" class="header-anchor">#</a> 终端二维码</h3> <p>qrcode-terminal</p> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-D</span> qrcode-terminal
</code></pre></div><p>使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> qrcode <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'qrcode-terminal'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https:www.baidu.com'</span>

qrcode<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">small</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">qrcode</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>qrcode<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="判断设备信息"><a href="#判断设备信息" class="header-anchor">#</a> 判断设备信息</h3> <p>使用navigator对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">checkdevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> browser <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">versions</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> u <span class="token operator">=</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">,</span>
        app <span class="token operator">=</span> navigator<span class="token punctuation">.</span>appVersion<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token comment">//移动终端浏览器版本信息</span>
        <span class="token literal-property property">trident</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;Trident&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//IE内核</span>
        <span class="token literal-property property">presto</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;Presto&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//opera内核</span>
        <span class="token literal-property property">webKit</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;AppleWebKit&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//苹果、谷歌内核</span>
        <span class="token literal-property property">gecko</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;Gecko&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;KHTML&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//火狐内核</span>
        <span class="token literal-property property">mobile</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>u<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">AppleWebKit.*Mobile.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//是否为移动终端</span>
        <span class="token literal-property property">ios</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>u<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\(i[^;]+;( U;)? CPU.+Mac OS X</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//ios终端</span>
        <span class="token literal-property property">android</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;Android&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;Linux&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//android终端或uc浏览器</span>
        <span class="token literal-property property">iPhone</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;iPhone&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//是否为iPhone或者QQHD浏览器</span>
        <span class="token literal-property property">iPad</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;iPad&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//是否iPad</span>
        <span class="token literal-property property">webApp</span><span class="token operator">:</span> u<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;Safari&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//是否web应该程序，没有头部与底部</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">language</span><span class="token operator">:</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>browserLanguage <span class="token operator">||</span> navigator<span class="token punctuation">.</span>language<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>mobile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//判断是否是移动设备打开。browser代码在下面</span>
    <span class="token comment">// 此时为移动端打开.跳转到移动站</span>
    <span class="token comment">// if(window.location.href.indexOf(&quot;ooo0o.com/mobile&quot;) != -1){</span>
    <span class="token comment">//     return;</span>
    <span class="token comment">// }else {</span>
    <span class="token comment">//     window.location.href = &quot;https://www.ooo0o.com/mobile&quot;</span>
    <span class="token comment">// }</span>

    <span class="token keyword">var</span> ua <span class="token operator">=</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取判断用的对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">MicroMessenger</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;micromessenger&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//在微信中打开</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>ios<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;weixinios&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;weixin&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>android<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//是否在安卓浏览器打开</span>

      <span class="token comment">// alert('安卓手机中打开的');</span>
      <span class="token comment">/*window.location.href=&quot;https://jushizhibo.com/android/app-release.apk&quot;;*/</span>
      <span class="token comment">// window.open('https://jushizhibo.com/android/app-release.apk','_self')</span>
      <span class="token keyword">return</span> <span class="token string">&quot;anzhuo&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>ios<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//是否在IOS浏览器打开</span>
      <span class="token comment">// alert('IOS中打开的');</span>
      <span class="token comment">/*window.location.href=&quot;https://www.baidu.com&quot;;*/</span>
      <span class="token comment">// window.open('transparentfactory://xiangqingye','_self')</span>
      <span class="token keyword">return</span> <span class="token string">&quot;ios&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//此时是非移动端,则跳转PC站</span>
    <span class="token comment">// alert('PC中打开的');</span>
    <span class="token comment">// if(window.location.href.indexOf(&quot;ooo0o.com/mobile&quot;) != -1){</span>
    <span class="token comment">//     window.location.href = &quot;https://www.ooo0o.com&quot;</span>
    <span class="token comment">// }</span>
    <span class="token keyword">return</span> <span class="token string">&quot;pc&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用时导入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>checkdevice<span class="token punctuation">}</span>  <span class="token keyword">from</span> <span class="token string">'checkdevice.js'</span>
</code></pre></div><h3 id="七牛云的使用"><a href="#七牛云的使用" class="header-anchor">#</a> 七牛云的使用</h3> <p>安装七牛包</p> <div class="language-node extra-class"><pre class="language-text"><code>npm install qiniu
</code></pre></div><p>新建文件，设置七牛云参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> bucket<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>
<span class="token keyword">var</span> imageUrl<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>
<span class="token keyword">var</span> accessKey <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
<span class="token keyword">var</span> secretKey <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
<span class="token keyword">var</span> mac <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>digest<span class="token punctuation">.</span>Mac</span><span class="token punctuation">(</span>accessKey<span class="token punctuation">,</span>secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> option<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">scope</span><span class="token operator">:</span>bucket<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> putPolicy<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>rs<span class="token punctuation">.</span>PutPolicy</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>
<span class="token keyword">var</span> uploadToken <span class="token operator">=</span> putPolicy<span class="token punctuation">.</span><span class="token function">uploadToken</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上传代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

config<span class="token punctuation">.</span>zone<span class="token operator">=</span> qiniu<span class="token punctuation">.</span>zone<span class="token punctuation">.</span>Zone_z0<span class="token punctuation">;</span><span class="token comment">//选择七牛云的机房</span>
<span class="token comment">//是否使用https、是否使用cdn加速</span>
config<span class="token punctuation">.</span>usehttpsDomain<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>useCdnDomain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> formUploader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>form_up<span class="token punctuation">.</span>FormUploader</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> putExtra <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>form_up<span class="token punctuation">.</span>PutExtra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

formUploader<span class="token punctuation">.</span><span class="token function">putFile</span><span class="token punctuation">(</span>uploadToken<span class="token punctuation">,</span>key<span class="token punctuation">,</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>pathName<span class="token punctuation">)</span><span class="token punctuation">,</span>putExtra<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">respErr<span class="token punctuation">,</span>respBody<span class="token punctuation">,</span>respInfo</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>resqErr<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">throw</span> respErr<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>respInfo<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>respBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>respInfo<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>respBody<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>                                                   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>https://segmentfault.com/a/1190000017064729</p> <h3 id="发邮件"><a href="#发邮件" class="header-anchor">#</a> 发邮件</h3> <p>导入模块Nodemailer</p> <div class="language-node extra-class"><pre class="language-text"><code>npm install nodemailer
</code></pre></div><p>使用方法(包官网https://nodemailer.com/)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//引入包</span>
<span class="token keyword">const</span> nodemailer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;nodemailer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创建邮件请求对象（qq邮箱、163邮箱或其他）</span>
  <span class="token keyword">let</span> transporter <span class="token operator">=</span> nodemailer<span class="token punctuation">.</span><span class="token function">createTransport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&quot;smtp.ethereal.email&quot;</span><span class="token punctuation">,</span><span class="token comment">//邮箱服务器</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">587</span><span class="token punctuation">,</span>（端口号）
    <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// true for 465, false for other ports</span>
    <span class="token literal-property property">auth</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">user</span><span class="token operator">:</span> testAccount<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token comment">// 账号</span>
      <span class="token literal-property property">pass</span><span class="token operator">:</span> testAccount<span class="token punctuation">.</span>pass <span class="token comment">// 你的邮箱服务器请求密码</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//所发送的邮件信息</span>
  <span class="token keyword">let</span> mailobj<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">'&quot;Fred Foo 👻&quot; &lt;foo@example.com&gt;'</span><span class="token punctuation">,</span> <span class="token comment">// sender address</span>
    <span class="token literal-property property">to</span><span class="token operator">:</span> <span class="token string">&quot;bar@example.com, baz@example.com&quot;</span><span class="token punctuation">,</span> <span class="token comment">// list of receivers</span>
    <span class="token literal-property property">subject</span><span class="token operator">:</span> <span class="token string">&quot;Hello ✔&quot;</span><span class="token punctuation">,</span> <span class="token comment">// Subject line</span>
    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&quot;Hello world?&quot;</span><span class="token punctuation">,</span> <span class="token comment">// plain text body</span>
    <span class="token literal-property property">html</span><span class="token operator">:</span> <span class="token string">&quot;&lt;b&gt;Hello world?&lt;/b&gt;&quot;</span> <span class="token comment">// html body</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//发送邮件</span>
  transporter<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>mailobj<span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre></div><h3 id="md5加密包"><a href="#md5加密包" class="header-anchor">#</a> MD5加密包</h3> <p>Js-md5</p> <h3 id="http爬虫"><a href="#http爬虫" class="header-anchor">#</a> http爬虫</h3> <h3 id="node应用打包可执行文件"><a href="#node应用打包可执行文件" class="header-anchor">#</a> node应用打包可执行文件</h3> <p>pkg可以将node项目打包为一个单独的可执行文件，在未安装nodejs的机器上运行。支持win、linux等多系统</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> pkg --save-dev
</code></pre></div><h3 id="node应用部署docker"><a href="#node应用部署docker" class="header-anchor">#</a> Node应用部署Docker</h3> <p>Docker允许你以应用程序所有的依赖打包成一个标准化的单元，这被称为一个容器，对于应用开发而言，一个容器就是一个蜕化到最基础的linux操作系统，一个镜像是你加载到容器中的软件</p> <p>在node app应用的目录下新建一个Dockerfile，编辑这个文件</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token comment">#从Docker站点获取相关镜像</span>
<span class="token instruction"><span class="token keyword">From</span> node:12</span>
<span class="token comment">#在镜像中创建一个文件夹存放应用程序代码，这将是应用程序工作的目录</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /usr/src/app</span>
<span class="token comment">#安装应用程序的所有依赖</span>
<span class="token instruction"><span class="token keyword">COPY</span> package*.json ./</span>

<span class="token instruction"><span class="token keyword">RUN</span> npm install </span>
<span class="token comment">#在Docker镜像中使用COPY命令绑定你的应用程序</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token comment">#定义映射端口，如应用程序的端口为8080，则与docker的镜像做映射</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 8080</span>
<span class="token comment">#最后要定义运行时的CMD命令来运行应用程序，这里使用node serverjs启动服务器</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;node&quot;</span>,<span class="token string">&quot;server.js&quot;</span>]</span>
</code></pre></div><p>在dockerfile的同一个文件夹下创建.dockerignore文件，带有以下内容</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code>node_modules
npm-debug.log
</code></pre></div><p>这将避免本地模块和调试日志被拷贝进入你的Docker镜像中，不会把镜像中安装的模块覆盖</p> <p>准备好之后就可以使用命令行构建和运行镜像</p> <p>进入dockerfile所在的目录，运行命令构建镜像</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> build <span class="token parameter variable">-t</span> <span class="token operator">&lt;</span>username<span class="token operator">&gt;</span>/node-web-app
</code></pre></div><p>构建之后就可以显示或者运行镜像</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code>docker images
</code></pre></div><p>使用-d模式以分离模式运行docker容器，使得容器在后台自助运行</p> <p>开关符-p在容器中把一个公共端口导向到私有的端口</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">49160</span>:8080 <span class="token parameter variable">-d</span> <span class="token operator">&lt;</span>username<span class="token operator">&gt;</span>/node-web-app
</code></pre></div><h2 id="node常见问题汇总"><a href="#node常见问题汇总" class="header-anchor">#</a> Node常见问题汇总</h2> <h3 id="npm-err-maximum-call-stack-size-exceeded"><a href="#npm-err-maximum-call-stack-size-exceeded" class="header-anchor">#</a> npm ERR! Maximum call stack size exceeded</h3> <p>解决方法：全局更新npm</p> <div class="language-node extra-class"><pre class="language-text"><code>npm install npm -g
</code></pre></div><h3 id="core-js"><a href="#core-js" class="header-anchor">#</a> core-js</h3> <p>warning react-native &gt; create-react-class &gt; fbjs &gt; core-js@1.2.7: core-js@&lt;2.6.8 is no longer maintained. Please, upgrade to core-js@3 or at least to actual version of core-js@2</p> <p>旧包不在维护，安装新包，自动卸载旧版本</p> <div class="language-node extra-class"><pre class="language-text"><code>npm install --save core-js@^3
</code></pre></div><p>注意：警告可能是由于你所安装的新包在使用旧版本的依赖所导致的警告，但是如果不是你自己开发的，你不能更改包的源码和依赖项，所以这种情况忽略警告吧</p> <h2 id="学习资源"><a href="#学习资源" class="header-anchor">#</a> 学习资源</h2> <p>node问答：https://github.com/jimuyouyou/node-interview-questions</p> <p>https://javascript.ruanyifeng.com/</p> <p>https://markpop.github.io/2014/10/29/NodeJs%E6%95%99%E7%A8%8B/</p> <p>node包讲解：https://github.com/chyingp/nodejs-learning-guide</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3979e060.js" defer></script><script src="/assets/js/2.0f8cbb55.js" defer></script><script src="/assets/js/1.ff82b27c.js" defer></script><script src="/assets/js/26.3764ddb4.js" defer></script>
  </body>
</html>
